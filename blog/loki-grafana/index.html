<!doctype html>
<html lang="fr" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Utilisation de Loki pour Centraliser les logs | TheBidouilleur</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/img/BMO.png"><meta data-rh="true" name="twitter:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/img/BMO.png"><meta data-rh="true" property="og:url" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/loki-grafana"><meta data-rh="true" name="docusaurus_locale" content="fr"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="fr"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" property="og:title" content="Utilisation de Loki pour Centraliser les logs | TheBidouilleur"><meta data-rh="true" name="description" content="[ Cet article provient de mon ancien-blog, celui-ci sera également disponible dans la partie “Documentation” du site ]"><meta data-rh="true" property="og:description" content="[ Cet article provient de mon ancien-blog, celui-ci sera également disponible dans la partie “Documentation” du site ]"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-12-12T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://git.thoughtless.eu"><meta data-rh="true" property="article:tag" content="Docker,Logs"><link data-rh="true" rel="icon" href="/TheBidouilleur.xyz/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/loki-grafana"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/loki-grafana" hreflang="en"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/loki-grafana" hreflang="fr"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/loki-grafana" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TheBidouilleur.xyz/blog/rss.xml" title="TheBidouilleur RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TheBidouilleur.xyz/blog/atom.xml" title="TheBidouilleur Atom Feed">



<script src="https://stats.192168128.xyz/js/script.js" defer="defer" data-domain="thebidouilleur.xyz"></script><link rel="stylesheet" href="/TheBidouilleur.xyz/assets/css/styles.55be8588.css">
<link rel="preload" href="/TheBidouilleur.xyz/assets/js/runtime~main.0154b50f.js" as="script">
<link rel="preload" href="/TheBidouilleur.xyz/assets/js/main.ca8c5350.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Aller au contenu principal"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Aller au contenu principal</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Ouvrir/fermer la barre de navigation" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TheBidouilleur.xyz/"><div class="navbar__logo"><img src="/TheBidouilleur.xyz/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--light_HNdA"><img src="/TheBidouilleur.xyz/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TheBidouilleur</b></a><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TheBidouilleur.xyz/blog">Blog</a><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>Français</a><ul class="dropdown__menu"><li><a href="/TheBidouilleur.xyz/en/blog/loki-grafana" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/TheBidouilleur.xyz/blog/loki-grafana" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="fr">Français</a></li></ul></div><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/blog/archive">Archives</a><a href="https://twitter.com/thebidouilleur" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-label="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Navigation article de blog récent"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/Mon-Setup">Mon matériel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/Creer-son-registre-helm">Créer son propre registre helm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/kubernetes-hcl">Kubernetes en HCL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/cluster-maj">Gardez vos clusters à jour</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/remarkable">Remarkable, une avancée dans les prises de notes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/nixos">NixOS, Ma nouvelle distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/gyroroue">Mes débuts à la gyroroue</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/longhorn">Longhorn, stockage distribué</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/s3contabo">Mes débuts avec s3</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/presentation-packer">Présentation rapide de Packer</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/TheBidouilleur.xyz/blog/loki-grafana">Utilisation de Loki pour Centraliser les logs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/caddy">Mon voyage autour des loadbalancers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/blog/presentation-docker-swarm">Présentation rapide de Docker-Swarm</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Utilisation de Loki pour Centraliser les logs</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-12-12T00:00:00.000Z" itemprop="datePublished">12 décembre 2021</time> · <!-- -->8 minutes de lecture</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://git.thoughtless.eu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://git.thoughtless.eu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>[ Cet article provient de mon ancien-blog, celui-ci sera également disponible dans la partie “Documentation” du site ]</p><h1>Introduction</h1><p>Depuis que jai commencé l’informatique (depuis un peu moins d’une dizaine d’année), je ne me suis jamais préoccupé de comment je visualisais mes logs. Un petit <em>view</em> par ci, un gros <em>grep</em> par là.. mais aucune gestion avancée. </p><p>J’ai basé ma supervision sur Zabbix et Grafana qui m’affichent les metriques de chaque machine virtuelle individuellement. Et même si c’est bien pratique, je n’ai presque aucun visuel sur l’état de mes applications !
J’ai donc décidé de me renseigner sur Graylog et Elastic Search proposant un stack assez fiable et facile à mettre en place. Puis en voyant les ressources demandées, j’ai remis ce besoin à “plus tard”, et j’ai remis “plus tard” à l’année prochaine.. Et ainsi de suite ! </p><blockquote><blockquote><p>2 ans plus tard…</p></blockquote></blockquote><p>Aujourd’hui <em>(Decembre 2021)</em>, une grosse faille 0day est dévoilée concernant Log4J, et on ne parle pas d’une “petite” faille, c’est une bonne grosse RCE comme on les aime ! </p><p>Je ne suis pas concerné par Log4J, ce n’est pas utilisé dans Jenkins, et je n’ai aucune autre application basée sur Java ouverte sur internet. Mais j’aurai bien aimé savoir si mon serveur a été scanné par les mêmes IP que l’on retrouve sur les listes à bannir.
Et c’est avec cet évenement que j’ai décidé de me renseigner sur <em>“Comment centraliser et visualiser ses logs?”</em>.</p><h1>Le choix du stack</h1><p>Un stack est un groupement de logiciel permettant de répondre à une fonction.
Un exemple classique est celui du stack “G.I.T.” <em>(et non pas comme l’outil de versioning!)</em> :</p><ul><li>Grafana</li><li>Influxdb</li><li>Telegraf </li></ul><p>C’est un stack qui permet de visualiser les mectriques de différentes machines, InfluxDB est la base de donnée stockant les informations, Telegraf est l’agent qui permet aux machines d’envoyer les métriques, et Grafana est le service web permettant de les visualiser.</p><p>Comme dit dans l’introduction, j’utilise Zabbix qui me permet de monitorer et collecter les metriques, et j’y ai couplé Grafana pour les afficher avec beaucoup de paramètrages. </p><p>Dans la centralisation de logs (et la visualisation), on parle souvent du stack suivant:</p><p><strong><strong>ELK</strong></strong>:</p><ul><li>ElasticSearch</li><li>Logstash</li><li>Kibana</li></ul><p>Mais ce stack n’est pas à déployer dans n’importe quel environnement, il est efficace, mais très lourd. </p><p>Dans ma quête pour trouver un stack permettant la centralisation de logs, j’apprécierai utiliser des services que je dispose déjà.<br>
<!-- -->Et voici le miracle à la mode de 2021 ! Le Stack GLP : <strong>Grafana, Loki, Promtail</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stack-glp">Stack GLP<a href="#stack-glp" class="hash-link" aria-label="Lien direct vers Stack GLP" title="Lien direct vers Stack GLP">​</a></h2><p>Là où j’apprécie particulièrement ce stack, c’est qu’il est léger. Beaucoup
plus léger que ELK qui, même si très efficace, demande beaucoup.</p><p><img loading="lazy" src="https://i.imgur.com/oWOwWsJ.png" class="img_ev3q"></p><p>De même que Graylog2 + Elastic Search (une très bonne alternative) qui demande presque un serveur baremetal low-cost à lui seul.
<img loading="lazy" src="https://i.imgur.com/FkAq6sO.png" class="img_ev3q"></p><p>Alors que Grafana / Loki ne demanderont que 2Go pour fonctionner efficacement et sans contraintes. (Grand maximum, à mon échelle : j’utiliserai beaucoup moins que 2Go)</p><h1>Installer notre stack</h1><p>Je pars du principe que tout le monde sait installer un Grafana, c’est souvent vers ce service que les gens commencent l’auto-hebergement <em>(en même temps, les graphiques de grafana sont super sexy !)</em>. </p><p>Mais si vous n’avez pas encore installé votre Grafana <em>(dans ce cas, quittez la salle et revenez plus tard)</em>, <a href="https://grafana.com/docs/grafana/latest/installation/" target="_blank" rel="noopener noreferrer">voici un lien qui vous permettra de le faire assez rapidement</a></p><p>Par simplicité, je ne vais pas utiliser Docker dans cette installation. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partie-loki">Partie Loki<a href="#partie-loki" class="hash-link" aria-label="Lien direct vers Partie Loki" title="Lien direct vers Partie Loki">​</a></h2><p>J’ai installé Loki sur un conteneur LXC en suivant le guide sur le site officiel <a href="https://grafana.com/docs/loki/latest/installation/local/" target="_blank" rel="noopener noreferrer">ici</a>.
Je passe par systemd pour lancer l’executable, et je créé à l’avance un fichier
avec le minimum syndical (qui est disponible sur le github de Grafana)</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http_listen_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">grpc_listen_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">common</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path_prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">filesystem</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chunks_directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/loki/chunks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">rules_directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/loki/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replication_factor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instance_addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kvstore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inmemory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">schema_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token datetime number" style="color:#36acaa">2020-10-24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> boltdb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shipper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">object_store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">schema</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">index</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> index_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">period</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 24h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Je n’ai pas pris la peine d’activer l’authentification en sachant que je suis dans un LAN avec uniquement mes machines virtuelles. Je considère pas que mon Loki comme un point sensible de mon infra. </p><p>Après seulement 2-3 minutes de configuration, notre Loki est déjà disponible ! </p><p>On peut dès maintenant l’ajouter en tant que <em>datasource</em> sur notre Grafana :
<img loading="lazy" src="https://i.imgur.com/G3tWx1r.png" class="img_ev3q"></p><p><em>(J’utilise localhost car la machine possédant le grafana héberge également le Loki)</em></p><p><em>Il se peut que Grafana rale un peu car notre base de donnée Loki est vide.</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partie-promtail">Partie Promtail<a href="#partie-promtail" class="hash-link" aria-label="Lien direct vers Partie Promtail" title="Lien direct vers Partie Promtail">​</a></h2><p>Promtail est l’agent qui va nous permettre d’envoyer nos logs à Loki, j’ai écris un role Ansible assez simple me permettant d’installer notre agent sur de nombreuses machines en surveillant les logs provenant de Docker, varlog et syslog. </p><p>Voici ma template Jinja2 à propos de ma configuration : </p><div class="language-jinja2 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jinja2 codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http_listen_port: 9080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grpc_listen_port: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">positions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename: /tmp/positions.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clients:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if loki_url is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - url: {{ loki_url }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scrape_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: authlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: authlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/log/auth.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: syslog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: syslog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/log/syslog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: Containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: containerslogs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/lib/docker/containers/*/*-json.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: DaemonLog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: daemon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/log/daemon.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>Si vous n’êtes pas à l’aise avec des templates Jinja2, vous trouverez une version “pure” de la config <a href="https://git.thoughtless.eu/Cinabre/rolePromtailAgent/src/branch/master/README.md" target="_blank" rel="noopener noreferrer">ici</a></em></p><p>Vous pouvez bien evidemment adapter cette template à vos besoins. Mon idée première est d’avoir une “base” que je peux mettre sur chaque machine <em>(en sachant aussi que si aucun log n’est disponible, comme pour Docker, Promtail ne causera pas une erreur en ne trouvant pas les fichiers)</em> </p><p>Une fois Promtail configuré, on peut le démarrer :
via l’executable directement : </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/opt/promtail/promtail -config.file /opt/promtail/promtail-local-config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ou via systemd <em>(automatique si vous passez par mon playbook)</em> :<br>
<code>systemctl start promtail</code> </p><p>Une fois cet agent un peu partout, on va directement aller s’amuser sur Grafana !</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="faire-des-requetes-à-loki-depuis-grafana">Faire des requetes à Loki depuis Grafana<a href="#faire-des-requetes-à-loki-depuis-grafana" class="hash-link" aria-label="Lien direct vers Faire des requetes à Loki depuis Grafana" title="Lien direct vers Faire des requetes à Loki depuis Grafana">​</a></h2><p>On va faire quelque chose d’assez contre-intuitif : nous n’allons pas commencer par faire un Dashboard : on va d’abord tester nos requetes !
<em>Scrollez pas, je vous jure que c’est la partie la plus fun !</em></p><p>Sur Grafana, nous avons un onglet “Explore”. Celui-ci va nous donner accès à Loki en écrivant des requetes, celles-ci sont assez simple, et surtout en utilisant l’outil “click-o-drome” en dépliant le <em>Log Browser</em>
<img loading="lazy" src="https://i.imgur.com/UNL2s6m.png" class="img_ev3q"></p><center> <i> Pardon j&#x27;ai un chouïa avancé sans vous... </i> </center><p>Avec la template que je vous ai donné, vous aurez 4 jobs : </p><ul><li>daemon</li><li>authlog</li><li>syslog</li><li>containersjobs</li></ul><p>Ces jobs permettent de trier les logs, on va tester ça ensemble. Nous allons donc selectionner la machine <em>“Ansible”</em>, puis demander le job <em>“authlog”</em>.
Je commence par cliquer sur Ansible, puis Authlog. Grafana me proposera exactement si je souhaite choisir un fichier spécifique. Si on ne précise pas de fichier(<em>filename</em>) Grafana prendra tous les fichiers <em>(donc aucune importance si nous n’avons qu’un seul fichier)</em> </p><p><em>(vous remarquerez plus tard que dès notre 1ere selection, grafana va cacher les jobs/hôte/fichier qui ne concernent pas notre début de requete)</em> </p><p><img loading="lazy" src="https://i.imgur.com/MWFQCyl.png" class="img_ev3q"></p><p>En validant notre requete (<em>bouton <strong>show logs</strong></em>)</p><p><img loading="lazy" src="https://i.imgur.com/RCpb5GI.png" class="img_ev3q"></p><p>Nous avons donc le résultat de la requete vers Loki dans le lapse de temps configuré dans Grafana (1h pour moi).
Mon authlog n’est pas très interessant, et mon syslog est pollué par beaucoup
de message pas très pertinents. </p><p>Nous allons donc commencer à <strong>trier</strong> nos logs !</p><p>En cliquant sur le petit ”<strong><em>?</em></strong>” au dessus de notre requete, nous avons une
“cheatsheet” résumant les fonctions basiques de Loki.
Nous découvrons comment faire une recherche exacte avec <em>|=</em>, comment ignorer
les lignes avec <em>!=</em> et comment utiliser une expression regulière avec <em>|~</em></p><p>Je vous partage également une cheatsheet un peu plus complète que j’ai trouvé
sur un blog : <a href="https://megamorf.gitlab.io/cheat-sheets/loki/" target="_blank" rel="noopener noreferrer">ici</a> </p><p>Ainsi, on peut directement obtenir des logs un peu plus colorés qui nous permettrons de cibler l’essentiel ! </p><p><img loading="lazy" src="https://i.imgur.com/HzTwmwW.png" class="img_ev3q"></p><p>(L’idée est de cibler les logs sympas avec les couleurs qui vont avec) </p><h1>Conclusion</h1><p>Si on entend souvent parler de la suite ELK, ça n’est pas non-plus une raison
pour s’en servir à tout prix ! Loki est une bonne alternative proposant des
fonctionnalitées basiques qui suffiront pour la plupart.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags :</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/blog/tags/docker">Docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/blog/tags/logs">Logs</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/QJoly/TheBidouilleur.xyz/tree/main/blog/2021-12-12-Loki.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Éditer cette page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Pagination des articles du blog"><a class="pagination-nav__link pagination-nav__link--prev" href="/TheBidouilleur.xyz/blog/presentation-packer"><div class="pagination-nav__sublabel">Article plus récent</div><div class="pagination-nav__label">Présentation rapide de Packer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/TheBidouilleur.xyz/blog/caddy"><div class="pagination-nav__sublabel">Article plus ancien</div><div class="pagination-nav__label">Mon voyage autour des loadbalancers</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#stack-glp" class="table-of-contents__link toc-highlight">Stack GLP</a></li><li><a href="#partie-loki" class="table-of-contents__link toc-highlight">Partie Loki</a></li><li><a href="#partie-promtail" class="table-of-contents__link toc-highlight">Partie Promtail</a></li><li><a href="#faire-des-requetes-à-loki-depuis-grafana" class="table-of-contents__link toc-highlight">Faire des requetes à Loki depuis Grafana</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/docs/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Me Suivre</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/TheBidouilleur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://thebidouilleur.xyz/blog/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Flux RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/blog/archive">Archives</a></li><li class="footer__item"><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="footer__link-item">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 TheBidouilleur.</div></div></div></footer></div>
<script src="/TheBidouilleur.xyz/assets/js/runtime~main.0154b50f.js"></script>
<script src="/TheBidouilleur.xyz/assets/js/main.ca8c5350.js"></script>
</body>
</html>