"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5179],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=r.createContext({}),p=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=p(n),d=a,f=m["".concat(o,".").concat(d)]||m[d]||u[d]||i;return n?r.createElement(f,s(s({ref:t},c),{},{components:n})):r.createElement(f,s({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=m;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:a,s[1]=l;for(var p=2;p<i;p++)s[p]=n[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4329:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const i={slug:"sops",title:"Stocker des secrets dans un d\xe9p\xf4t Git",tags:["gitops","sops"],description:"Sops est un utilitaire cr\xe9\xe9 par Mozilla permettant de chiffrer ses secrets"},s=void 0,l={unversionedId:"Adminsys/sops",id:"Adminsys/sops",title:"Stocker des secrets dans un d\xe9p\xf4t Git",description:"Sops est un utilitaire cr\xe9\xe9 par Mozilla permettant de chiffrer ses secrets",source:"@site/docs/Adminsys/sops.md",sourceDirName:"Adminsys",slug:"/Adminsys/sops",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/sops",draft:!1,editUrl:"https://github.com/QJoly/TheBidouilleur.xyz/tree/main/docs/Adminsys/sops.md",tags:[{label:"gitops",permalink:"/TheBidouilleur.xyz/en/docs/tags/gitops"},{label:"sops",permalink:"/TheBidouilleur.xyz/en/docs/tags/sops"}],version:"current",frontMatter:{slug:"sops",title:"Stocker des secrets dans un d\xe9p\xf4t Git",tags:["gitops","sops"],description:"Sops est un utilitaire cr\xe9\xe9 par Mozilla permettant de chiffrer ses secrets"},sidebar:"tutorialSidebar",previous:{title:"Boot PXE avec netboot",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/netbootxyz"},next:{title:"V\xe9rification configuration syst\xe8me (testinfra)",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/testinfra"}},o={},p=[{value:"Cr\xe9er notre cl\xe9 Age",id:"cr\xe9er-notre-cl\xe9-age",level:2},{value:"Sops, en pratique",id:"sops-en-pratique",level:2}],c={toc:p};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\xc9viter d\u2019envoyer ses secrets sur Git, nous devons toujours \xeatre vigileant avant un quelconque Push. Et c\u2019est justement le but de  ",(0,a.kt)("strong",{parentName:"p"},"Sops")," ",(0,a.kt)("em",{parentName:"p"},"(Secrets OPerationS)")," qui va nous aider \xe0 stocker nos informations sur le d\xe9p\xf4t.. mais en les chiffrant."),(0,a.kt)("p",null,"Celui-ci est compatible avec de nombreux gestionnaires de secret comme : "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Hashicorp Vault"),(0,a.kt)("li",{parentName:"ul"},"GCP KMS"),(0,a.kt)("li",{parentName:"ul"},"PGP"),(0,a.kt)("li",{parentName:"ul"},"Age ",(0,a.kt)("em",{parentName:"li"},"(Celui que nous allons utiliser)"))),(0,a.kt)("admonition",{title:"Age",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Age est un outil en Go simple et moderne. Celui-ci propose un format qui semble \xeatre valid\xe9 par de nombreux experts.")),(0,a.kt)("h2",{id:"cr\xe9er-notre-cl\xe9-age"},"Cr\xe9er notre cl\xe9 Age"),(0,a.kt)("p",null,"Nous allons donc cr\xe9er notre propre cl\xe9 avec age. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p ~/.keys/\nage-keygen -o ~/.keys/ma-cle\n")),(0,a.kt)("p",null,"En inspectant le contenu du fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.keys/ma-cle"),", nous remarquons un sch\xe9ma que l\u2019on connait bien : une cl\xe9 publique, et une cl\xe9 priv\xe9e. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# created: 2023-02-15T07:50:20+01:00\n# public key: age1220x7zmnp0j8du3vxk67a4mdkr3gqn9djjn7f7gamjclr3em7g2sxpns35\nAGE-SECRET-KEY-1JY9Q0NWNRK4DCT9J3D2H0Z9D5ZY0XHV8EJ39JKKK2PW6SUH9FTFSN9T6HF\n")),(0,a.kt)("p",null,"Et pour que ",(0,a.kt)("em",{parentName:"p"},"Sops")," utilise cette cl\xe9, nous allons cr\xe9er la variable d\u2019environnement ",(0,a.kt)("inlineCode",{parentName:"p"},"SOPS_AGE_KEY_FILE")," dans notre ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.bashrc")," ou ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.zshrs"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"export SOPS_AGE_KEY_FILE=~/.keys/ma-cle\n")),(0,a.kt)("p",null,"Maintenant, nous pouvons passer au niveau sup\xe9rieur : ",(0,a.kt)("strong",{parentName:"p"},"cr\xe9er notre premier fichier de secret"),"."),(0,a.kt)("h2",{id:"sops-en-pratique"},"Sops, en pratique"),(0,a.kt)("p",null,"Notre syst\xe8me d\u2019authentification est d\xe9j\xe0 cr\xe9\xe9 : c\u2019est notre couple de cl\xe9 AGE. Ce que nous allons faire maintenant, c\u2019est cr\xe9er un secret qui sera d\xe9chiffrable uniquement par notre cl\xe9 priv\xe9e."),(0,a.kt)("p",null,"Premi\xe8re chose que nous allons faire, c\u2019est cr\xe9er notre fichier ",(0,a.kt)("inlineCode",{parentName:"p"},".sops.yaml"),"."),(0,a.kt)("p",null,"Ce fichier permet de d\xe9finir quels fichiers devront \xeatre manoeuvr\xe9s par SOPS et surtout : quels cl\xe9s ont acc\xe8s \xe0 ces fichiers. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml"},'# .sops.yaml\ncreation_rules:\n    - path_regex: secret.*\\.ya?ml\n      encrypted_regex: "^(username|password)$"\n      key_groups:\n      - age:\n        - age1220x7zmnp0j8du3vxk67a4mdkr3gqn9djjn7f7gamjclr3em7g2sxpns35\n')),(0,a.kt)("p",null,"Cr\xe9ons maintenant un fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"secret.dev.yml"),": "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'username: "thebidouilleur"\npassword: jadorelabidouille\nurl: "https://thebidouilleur.xyz"\nQI: 7.2\n')),(0,a.kt)("p",null,"et affichons ce m\xeame fichier en le chiffrant avec sops via l\u2019argument ",(0,a.kt)("inlineCode",{parentName:"p"},"-e")," ",(0,a.kt)("em",{parentName:"p"},"(encrypt)"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'\u279c  sops -e secret.dev.yml\nusername: ENC[AES256_GCM,data:8KUxRrhWLWsbxzJqxRQ=,iv:qJQYUgCQ6wv9fmn+scJ3ui7tFD6lpoRH0qpC+n58sF8=,tag:RJdluEfMdnXy6Zhpxn2AyQ==,type:str]\npassword: ENC[AES256_GCM,data:dm9t60SH/4/wqy3Ww5RxaDU=,iv:ch0ZRbhN6+ouCNXzgWO63GHK9ewgOMpfJMzjYxIq8h4=,tag:EKRHJBwRV8ZRRpDMaGG4sQ==,type:str]\nurl: https://thebidouilleur.xyz\nQI: 7.2\nsops:\n    kms: []\n    gcp_kms: []\n    azure_kv: []\n    hc_vault: []\n    age:\n        - recipient: age14ysm820ajay8wqslnkjqcewvq4tmeucth3a88qk4a7hl0mnwkfaqmj6xx5\n          enc: |\n            -----BEGIN AGE ENCRYPTED FILE-----\n            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHZU9xNklSTkRTU0p0SFV3\n            NE1tV2M2Wjk3SDl2a1lJWk8wQi96Yjk2eUVjCi9qSWREUkZqTFpOa1luZEFlb2lK\n            dHBBNDllSFlhL2cycW82SGl4bDU2YXcKLS0tIHd5aCsyK1BHT2dDTGpZWUxITE83\n            MFd5MlowTHNIekVXTzJWbXNuUmxGRWsKp1o+kh9lbWBLh6rZ4845c31rxowb9uX+\n            /a01TYbiWfn2lWmUJ+gXq0nQZxqo3iDEI+mrG+n+c79rmq6BGPYVPw==\n            -----END AGE ENCRYPTED FILE-----\n    lastmodified: "2023-02-15T11:44:32Z"\n    mac: ENC[AES256_GCM,data:cUtxnG/ycha3Zk0xNrmeioeBB9SiH3U4ENbnGtkpJmM9SBOFVZGKikaDZwdk1c2aflC07kELIoN0BxspgJseCLNvA3nsTYEEjHe53zJZUaDYn7u0D1+th3XjYdU17zdx9ECN5SjExvOIDLmQ4j512/LCN+lBVi4SxaJWDqzzva0=,iv:vhrbuibyInOxcYihgMVZN8c0v05GdPXB+EbACQijg9s=,tag:GHLv+agLCXcTiUDq8gBEkA==,type:str]\n    pgp: []\n    encrypted_regex: ^(username|password)$\n    version: 3.7.3\n')),(0,a.kt)("p",null,"Ni l\u2019URL, ni mon QI n\u2019ont \xe9t\xe9 chiffr\xe9s. Gardez \xe9galement en ",(0,a.kt)("em",{parentName:"p"},"t\xeate")," que la commande ",(0,a.kt)("strong",{parentName:"p"},"ne fait qu\u2019afficher un output du m\xeame fichier chiffr\xe9, le fichier n\u2019a pas \xe9t\xe9 modifi\xe9"),". "),(0,a.kt)("p",null,"Si on souhaite r\xe9-\xe9crire le fichier, il faut rajouter l\u2019argument ",(0,a.kt)("inlineCode",{parentName:"p"},"-i")," : ",(0,a.kt)("inlineCode",{parentName:"p"},"sops -e -i secret.dev.yml")),(0,a.kt)("p",null,"Pour d\xe9chiffrer le fichier, il suffit de faire la m\xeame commande en changeant ",(0,a.kt)("inlineCode",{parentName:"p"},"-e")," par ",(0,a.kt)("inlineCode",{parentName:"p"},"-d")," ",(0,a.kt)("em",{parentName:"p"},"(decrypt)"),"."),(0,a.kt)("p",null,"Si jamais je chiffre mon fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"secret.dev.yml")," et que je change de cl\xe9, nous serons dans l\u2019incapacit\xe9 de le chiffrer : "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'\u279c sops -d -i secret.dev.yml\nFailed to get the data key required to decrypt the SOPS file.\n\nGroup 0: FAILED\n  age14ysm820ajay8wqslnkjqcewvq4tmeucth3a88qk4a7hl0mnwkfaqmj6xx5: FAILED\n    - | no age identity found in "~/.keys/ma-cle" that\n      | could decrypt the data\n\nRecovery failed because no master key was able to decrypt the file. In\norder for SOPS to recover the file, at least one key has to be successful,\nbut none were.\n')),(0,a.kt)("p",null,"Pour ajouter une cl\xe9 pouvant d\xe9chiffrer les fichiers, rajoutez-l\xe0 dans votre ",(0,a.kt)("inlineCode",{parentName:"p"},".sops.yaml"),"."),(0,a.kt)("p",null,"En d\xe9chiffrant puis rechiffrant les fichiers, la nouvelle cl\xe9 y aura acc\xe8s."))}u.isMDXComponent=!0}}]);