"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7177],{4137:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>f});var r=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function u(e,n){if(null==e)return{};var t,r,l=function(e,n){if(null==e)return{};var t,r,l={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var s=r.createContext({}),i=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=i(e.components);return r.createElement(s.Provider,{value:n},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,l=e.mdxType,a=e.originalType,s=e.parentName,c=u(e,["components","mdxType","originalType","parentName"]),d=i(t),m=l,f=d["".concat(s,".").concat(m)]||d[m]||p[m]||a;return t?r.createElement(f,o(o({ref:n},c),{},{components:t})):r.createElement(f,o({ref:n},c))}));function f(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var a=t.length,o=new Array(a);o[0]=m;var u={};for(var s in n)hasOwnProperty.call(n,s)&&(u[s]=n[s]);u.originalType=e,u[d]="string"==typeof e?e:l,o[1]=u;for(var i=2;i<a;i++)o[i]=t[i];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},8497:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>u,toc:()=>i});var r=t(7462),l=(t(7294),t(4137));const a={slug:"cloudflared",title:"Exposer vos conteneurs sans NAT avec Cloudflared"},o=void 0,u={unversionedId:"Home/Cloudflared",id:"Home/Cloudflared",title:"Exposer vos conteneurs sans NAT avec Cloudflared",description:"Vous trouverez ici la documentation officielle de Cloudflare",source:"@site/docs/Home/Cloudflared.md",sourceDirName:"Home",slug:"/Home/cloudflared",permalink:"/TheBidouilleur.xyz/en/docs/Home/cloudflared",draft:!1,editUrl:"https://github.com/QJoly/TheBidouilleur.xyz/tree/main/docs/Home/Cloudflared.md",tags:[],version:"current",lastUpdatedAt:1688663870,formattedLastUpdatedAt:"Jul 6, 2023",frontMatter:{slug:"cloudflared",title:"Exposer vos conteneurs sans NAT avec Cloudflared"},sidebar:"tutorialSidebar",previous:{title:"V\xe9rification configuration syst\xe8me (testinfra)",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/testinfra"},next:{title:"QuteBrowser - Un navigateur bas\xe9 sur Vim",permalink:"/TheBidouilleur.xyz/en/docs/Home/QuteBrowser"}},s={},i=[{value:"Qu&#39;est ce que Cloudflared?",id:"quest-ce-que-cloudflared",level:2},{value:"Comment Utiliser Cloudflared ?",id:"comment-utiliser-cloudflared-",level:2},{value:"Installer Cloudflared (via Docker)",id:"installer-cloudflared-via-docker",level:3}],c={toc:i},d="wrapper";function p(e){let{components:n,...a}=e;return(0,l.kt)(d,(0,r.Z)({},c,a,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/"},"Vous trouverez ici la documentation officielle de Cloudflare")),(0,l.kt)("p",null,"Cloudflare est une entreprise qui est r\xe9put\xe9e pour son anti-ddos assez performant. Celui-ci se place en tant que serveur de nom pour nom de domaine et va faire l'intermediaire entre votre site et l'utilisateur.\nPersonnellement, je m'en sers surtout pour cacher l'IP publique de mon r\xe9seau et permettre \xe0 tous d'acc\xe9der \xe0 mes sites."),(0,l.kt)("p",null,"Et justement, cloudflare vient de sortir un petit programme assez pratique : ",(0,l.kt)("strong",{parentName:"p"},"cloudflared"),"."),(0,l.kt)("h2",{id:"quest-ce-que-cloudflared"},"Qu'est ce que Cloudflared?"),(0,l.kt)("p",null,"Cloudflared (qui se base sur Cloudflare Tunnel) permet de rendre une application accessible sur internet depuis un domaine g\xe9r\xe9 par cloudflare ",(0,l.kt)("strong",{parentName:"p"},"sans ouvrir de port")," !\nEn temps normal, voici ce qu'il se passe :"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"before cloudflared",src:t(1823).Z,width:"491",height:"170"})),(0,l.kt)("p",null,"Avantages:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Facile \xe0 faire")),(0,l.kt)("p",null,"Inconvenients:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Mon IP est visible de tous"),(0,l.kt)("li",{parentName:"ul"},"Difficult\xe9es si IP changeante")),(0,l.kt)("p",null,"Et voici comment fonctionne un site avec un tunnel Cloudflared.\n",(0,l.kt)("img",{alt:"after-cloudflared",src:t(5417).Z,width:"581",height:"275"})),(0,l.kt)("p",null,"Avantages:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Mon IP est cach\xe9e"),(0,l.kt)("li",{parentName:"ul"},"Syst\xe8me de cache (\xe9conomie de bande passante)")),(0,l.kt)("p",null,"Inconvenients:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Cloudflare n'est pas forcement fiable"),(0,l.kt)("li",{parentName:"ul"},"Complexe")),(0,l.kt)("p",null,"Cloudflared n'est pas forcement ",(0,l.kt)("strong",{parentName:"p"},"la bonne solution")," pour de nombreux contextes, (",(0,l.kt)("em",{parentName:"p"},"et interdit de s'en servir en Prod ou avec des donn\xe9es sensibles"),") mais dans mon cas (*quelques conteneurs simples, Blogs, gitea etc..), c'est exactement ce qu'il me faut."),(0,l.kt)("h2",{id:"comment-utiliser-cloudflared-"},"Comment Utiliser Cloudflared ?"),(0,l.kt)("p",null,"Concretement, on peut utiliser Cloudflared en tant que Daemon classique. Mais \xe9tant donn\xe9 que mon infrastructure est bas\xe9e sur Docker, je vais continuer \xe0 utiliser cette solution, et m\xeame pour Cloudflared."),(0,l.kt)("h3",{id:"installer-cloudflared-via-docker"},"Installer Cloudflared (via Docker)"),(0,l.kt)("p",null,"On va cr\xe9er un dossier qui accueillera notre configuration Cloudflared :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir $HOME/cloudflared\n")),(0,l.kt)("p",null,"Nous allons nous baser sur l'image Docker ",(0,l.kt)("strong",{parentName:"p"},"msnelling/cloudflared")," qui facilite beaucoup la configuration. (",(0,l.kt)("a",{parentName:"p",href:"https://github.com/msnelling/docker-cloudflared"},"Code-source ici"),")\nEt nous allons executer la commande  dans :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -v ${HOME}/cloudflared:/root/.cloudflared msnelling/cloudflared cloudflared tunnel login\n")),(0,l.kt)("p",null,"R\xe9sultat:\n",(0,l.kt)("img",{alt:"first run of cloudflared",src:t(3600).Z,width:"1351",height:"363"}),"\nVous devez indiquer \xe9galement le domaine utilis\xe9 pour ce tunnel."),(0,l.kt)("p",null,"Une fois connect\xe9 (via l'URL fournise), un message vous confirmera et vous aurez un fichier ",(0,l.kt)("strong",{parentName:"p"},"cert.pem")," dans votre dossier ",(0,l.kt)("em",{parentName:"p"},"$HOME/cloudflared"),". Cloudflared s'en servira pour acc\xe9der \xe0 votre compte."),(0,l.kt)("p",null,"Maintenant, nous devons cr\xe9er le tunnel ( qu'on pourra utiliser pour plusieurs domaines/applications )"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -v ${HOME}/cloudflared:/etc/cloudflared msnelling/cloudflared cloudflared tunnel create coffee_time\n")),(0,l.kt)("admonition",{type:"tip"},(0,l.kt)("p",{parentName:"admonition"},"Remplacez ",(0,l.kt)("em",{parentName:"p"},"coffee_time")," par le nom que vous voulez donner \xe0 votre tunnel.")),(0,l.kt)("p",null,"\xe0 la fin de la commande, vous devrez avoir un fichier terminant par ",(0,l.kt)("strong",{parentName:"p"},".json"),", le nom correspond \xe0 l'identifiant de votre tunnel, copiez le.\nCr\xe9ez le fichier ",(0,l.kt)("strong",{parentName:"p"},"$HOME/cloudflared/config.yaml")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"tunnel: your-tunnel-id-here\ningress:\n        - hostname: test.thoughtless.eu     # Change the domaine here\n          service: http://nginx:80          # http://container_name:port\n        - service: http_status:404\n")),(0,l.kt)("p",null,"Nous sommes connect\xe9s, notre tunnel est cr\xe9\xe9, nous pouvons maintenant d\xe9marrer cloudflared."),(0,l.kt)("p",null,"Cr\xe9ez le fichier ",(0,l.kt)("strong",{parentName:"p"},"docker-compose.yml")," avec le contenu suivant :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"version: '2'\nservices:\n   cloudflared:\n        image: msnelling/cloudflared\n        container_name: cloudflared\n        volumes:\n            - ${HOME}/cloudflared:/etc/cloudflared\n        command: /usr/local/bin/cloudflared tunnel --no-autoupdate run\n        restart: always\n        networks:\n            - cloudflared\nnetworks:\n  cloudflared:\n    name: cloudflared\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\ndocker-compose logs\n")),(0,l.kt)("p",null,"Si aucune erreur n'est pr\xe9sente (",(0,l.kt)("a",{parentName:"p",href:"https://i.imgur.com/Ehyao5E.png"},"exemple ici"),"), on peut directement utiliser cloudflared pour un autre conteneur."),(0,l.kt)("p",null,'Comme nous avons renseign\xe9 que le conteneur nomm\xe9 "',(0,l.kt)("em",{parentName:"p"},"nginx"),'" sera accessible via le domaine ',(0,l.kt)("em",{parentName:"p"},"test.thoughtless.eu"),", nous devons d\xe9ploy\xe9 un conteneur du m\xeame nom, dans le m\xeame r\xe9seau que le conteneur ",(0,l.kt)("em",{parentName:"p"},"cloudflared")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"version: '2'\nservices:\n  nginx:\n    image: nginx\n    networks:\n      - cloudflared\nnetworks:\n  cloudflared:\n    external: true\n    name: cloudflared\n")),(0,l.kt)("p",null,"D\xe9marrez le via la commande:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),(0,l.kt)("p",null,"La derni\xe8re \xe9tape est de se connecter \xe0notre panel cloudflare pour cr\xe9er une r\xe8gle cname vers notre tunnel.\nPour cela, vous devrez rajouter une entr\xe9e ",(0,l.kt)("em",{parentName:"p"},"CNAME")," vers ",(0,l.kt)("em",{parentName:"p"},"id-du-tunnel.cfargotunnel.com"),"."),(0,l.kt)("p",null,"Une fois valid\xe9, je peux acc\xe9der au conteneur Nginx via le domaine rentr\xe9 dans le ",(0,l.kt)("strong",{parentName:"p"},"config.yaml")),(0,l.kt)("p",null,(0,l.kt)("img",{parentName:"p",src:"https://i.imgur.com/lrSkfrX.png",alt:"It works"})))}p.isMDXComponent=!0},5417:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/after-cloudflared-75578f2892fca1bf0a42c1b9498c658f.png"},1823:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/before-cloudflared-34dbf5ab65d6a0965d2003a4ff5a7b40.png"},3600:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/cloudflared-first-run-294dcb16aefdc568fc6a0980c3586a1e.png"}}]);