"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7719],{4137:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>d});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),u=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=u(e.components);return a.createElement(o.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,o=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=u(t),d=r,k=m["".concat(o,".").concat(d)]||m[d]||c[d]||s;return t?a.createElement(k,i(i({ref:n},p),{},{components:t})):a.createElement(k,i({ref:n},p))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,i=new Array(s);i[0]=m;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<s;u++)i[u]=t[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},1272:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>c,frontMatter:()=>s,metadata:()=>l,toc:()=>u});var a=t(7462),r=(t(7294),t(4137));const s={title:"Loki - Surveillance de logs",slug:"loki",tags:["infra"]},i=void 0,l={unversionedId:"Adminsys/Loki",id:"Adminsys/Loki",title:"Loki - Surveillance de logs",description:"Introduction",source:"@site/docs/Adminsys/Loki.md",sourceDirName:"Adminsys",slug:"/Adminsys/loki",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/loki",draft:!1,editUrl:"https://github.com/QJoly/TheBidouilleur.xyz/tree/main/docs/Adminsys/Loki.md",tags:[{label:"infra",permalink:"/TheBidouilleur.xyz/en/docs/tags/infra"}],version:"current",frontMatter:{title:"Loki - Surveillance de logs",slug:"loki",tags:["infra"]},sidebar:"tutorialSidebar",previous:{title:"Utiliser libvirt en utilisateur non-root",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/rootless-libvirt"},next:{title:"Build Docker multi-architecture",permalink:"/TheBidouilleur.xyz/en/docs/Adminsys/MultiArch Build"}},o={},u=[{value:"Introduction",id:"introduction",level:2},{value:"Le choix du stack",id:"le-choix-du-stack",level:2},{value:"Stack GLP",id:"stack-glp",level:3},{value:"Installer notre stack",id:"installer-notre-stack",level:2},{value:"Partie Loki",id:"partie-loki",level:3},{value:"Partie Promtail",id:"partie-promtail",level:3},{value:"Faire des requetes \xe0 Loki depuis Grafana",id:"faire-des-requetes-\xe0-loki-depuis-grafana",level:3},{value:"Conclusion",id:"conclusion",level:2}],p={toc:u};function c(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"Depuis que jai commenc\xe9 l'informatique (depuis un peu moins d'une dizaine d'ann\xe9e), je ne me suis jamais pr\xe9occup\xe9 de comment je visualisais mes logs. Un petit ",(0,r.kt)("em",{parentName:"p"},"view")," par ci, un gros ",(0,r.kt)("em",{parentName:"p"},"grep")," par l\xe0.. mais aucune gestion avanc\xe9e. "),(0,r.kt)("p",null,"J'ai bas\xe9 ma supervision sur Zabbix et Grafana qui m'affichent les metriques de chaque machine virtuelle individuellement. Et m\xeame si c'est bien pratique, je n'ai presque aucun visuel sur l'\xe9tat de mes applications !\nJ'ai donc d\xe9cid\xe9 de me renseigner sur Graylog et Elastic Search proposant une stack assez fiable et facile \xe0 mettre en place. Puis en voyant les ressources demand\xe9es, j'ai remis ce besoin \xe0 \"plus tard\", et j'ai remis \"plus tard\" \xe0 l'ann\xe9e prochaine.. Et ainsi de suite ! "),(0,r.kt)("blockquote",null,(0,r.kt)("blockquote",{parentName:"blockquote"},(0,r.kt)("p",{parentName:"blockquote"},"2 ans plus tard\u2026"))),(0,r.kt)("p",null,"Aujourd'hui ",(0,r.kt)("em",{parentName:"p"},"(Decembre 2021)"),", une grosse faille 0day est d\xe9voil\xe9e concernant Log4J, et on ne parle pas d'une \"petite\" faille, c'est une bonne grosse RCE comme on les aime ! "),(0,r.kt)("p",null,"Je ne suis pas concern\xe9 par Log4J (ce n'est pas utilis\xe9 dans Jenkins et je n'ai aucune autre application bas\xe9e sur Java ouverte sur internet) mais j'aurais bien aim\xe9 savoir si mon serveur a \xe9t\xe9 scann\xe9 par les m\xeames IP que l'on retrouve sur les listes \xe0 bannir.\nEt c'est avec cet \xe9venement que j'ai d\xe9cid\xe9 de me renseigner sur ",(0,r.kt)("em",{parentName:"p"},'"Comment centraliser et visualiser ses logs?"'),"."),(0,r.kt)("h2",{id:"le-choix-du-stack"},"Le choix du stack"),(0,r.kt)("p",null,'Une stack est un groupement de logiciel permettant de r\xe9pondre \xe0 une fonction.\nUn exemple classique est celui du stack "G.I.T." ',(0,r.kt)("em",{parentName:"p"},"(et non pas comme l'outil de versioning!)")," :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Grafana"),(0,r.kt)("li",{parentName:"ul"},"Influxdb"),(0,r.kt)("li",{parentName:"ul"},"Telegraf ")),(0,r.kt)("p",null,"C'est une stack qui permet de visualiser les mectriques de diff\xe9rentes machines, InfluxDB est la base de donn\xe9e stockant les informations, Telegraf est l'agent qui permet aux machines d'envoyer les m\xe9triques, et Grafana est le service web permettant de les visualiser."),(0,r.kt)("p",null,"Comme dit dans l'introduction, j'utilise Zabbix qui me permet de monitorer et collecter les metriques, et j'y ai coupl\xe9 Grafana pour les afficher avec beaucoup de param\xe8trages. "),(0,r.kt)("p",null,"Dans la centralisation de logs (et la visualisation), on parle souvent du stack suivant:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("strong",{parentName:"strong"},"ELK")),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ElasticSearch"),(0,r.kt)("li",{parentName:"ul"},"Logstash"),(0,r.kt)("li",{parentName:"ul"},"Kibana")),(0,r.kt)("p",null,"Mais cette stack n'est pas \xe0 d\xe9ployer dans n'importe quel environnement, elle est efficace, mais tr\xe8s lourde. "),(0,r.kt)("p",null,"Dans ma qu\xeate pour trouver une stack permettant la centralisation de logs, j'appr\xe9cierais utiliser des services d\xe9j\xe0 existant dans mon infra.\nEt voici le miracle \xe0 la mode de 2021 ! La Stack GLP : ",(0,r.kt)("strong",{parentName:"p"},"Grafana, Loki, Promtail"),"."),(0,r.kt)("h3",{id:"stack-glp"},"Stack GLP"),(0,r.kt)("p",null,"L\xe0 o\xf9 j'appr\xe9cie particuli\xe8rement cette stack, c'est qu'elle est l\xe9gere. Nettement plus l\xe9g\xe8re que ELK qui, m\xeame si tr\xe8s efficace, demande beaucoup de ressources."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/oWOwWsJ.png",alt:null})),(0,r.kt)("p",null,"De m\xeame que Graylog2 + Elastic Search ",(0,r.kt)("em",{parentName:"p"},"(une tr\xe8s bonne alternative)")," qui demande presque un serveur baremetal low-cost \xe0 lui seul.\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/FkAq6sO.png",alt:null})),(0,r.kt)("p",null,"Alors que Grafana / Loki ne demanderont que 2Go pour fonctionner efficacement et sans contraintes. (et 2Go si les services sont tr\xe8s solicit\xe9s, je peux donc utiliser moins de RAM)"),(0,r.kt)("h2",{id:"installer-notre-stack"},"Installer notre stack"),(0,r.kt)("p",null,"Je pars du principe que tout le monde sait installer un Grafana, c'est souvent vers ce service que les gens commencent l'auto-h\xe9bergement et la supervision."),(0,r.kt)("p",null,"Mais si vous n'avez pas encore install\xe9 votre Grafana, ",(0,r.kt)("a",{parentName:"p",href:"https://grafana.com/docs/grafana/latest/installation/"},"voici la documentation officielle")),(0,r.kt)("p",null,"Par simplicit\xe9, je ne vais pas utiliser Docker dans cette installation. "),(0,r.kt)("h3",{id:"partie-loki"},"Partie Loki"),(0,r.kt)("p",null,"J'ai install\xe9 Loki sur un conteneur LXC en suivant le guide sur le site officiel ",(0,r.kt)("a",{parentName:"p",href:"https://grafana.com/docs/loki/latest/installation/local/"},"ici"),".\nJe passe par systemd pour lancer l'ex\xe9cutable, et je cr\xe9e \xe0 l'avance un fichier avec le minimum n\xe9c\xe9ssaire \xe0 Loki pour fonctionner."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"auth_enabled: false\n\nserver:\n  http_listen_port: 3100\n  grpc_listen_port: 9096\n\ncommon:\n  path_prefix: /tmp/loki\n  storage:\n    filesystem:\n      chunks_directory: /tmp/loki/chunks\n      rules_directory: /tmp/loki/rules\n  replication_factor: 1\n  ring:\n    instance_addr: 127.0.0.1\n    kvstore:\n      store: inmemory\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: boltdb-shipper\n      object_store: filesystem\n      schema: v11\n      index:\n        prefix: index_\n        period: 24h\n")),(0,r.kt)("p",null,"Apr\xe8s seulement 2-3 minutes de configuration, notre Loki est d\xe9j\xe0 disponible ! "),(0,r.kt)("p",null,"On peut d\xe8s maintenant l'ajouter en tant que ",(0,r.kt)("em",{parentName:"p"},"datasource")," sur notre Grafana :"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/G3tWx1r.png",alt:null})),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"(Dans mon cas, la base Loki est install\xe9e sur la m\xeame machine que mon Grafana)")),(0,r.kt)("p",null,"Vous aurez une erreur de Grafana si votre base Loki est vide, nous allons directement voir comment envoyer nos premiers logs."),(0,r.kt)("h3",{id:"partie-promtail"},"Partie Promtail"),(0,r.kt)("p",null,"Promtail est l'agent qui va nous permettre d'envoyer nos logs \xe0 Loki, j'ai \xe9cris un role Ansible assez simple me permettant d'installer notre agent sur de nombreuses machines en surveillant les logs provenant de Docker, varlog et syslog. "),(0,r.kt)("p",null,"Voici ma template Jinja2 \xe0 propos de ma configuration : "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jinja2"},"server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n{% if loki_url is defined %}\n  - url: {{ loki_url }}\n{% endif %} \n\n\nscrape_configs:\n\n\n- job_name: authlog\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n{% if ansible_hostname is defined %}\n      host: {{ ansible_hostname }}\n{% endif %} \n      job: authlog\n      __path__: /var/log/auth.log\n\n\n- job_name: syslog\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n{% if ansible_hostname is defined %}\n      host: {{ ansible_hostname }}\n{% endif %}\n      job: syslog\n      __path__: /var/log/syslog\n\n- job_name: Containers\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n{% if ansible_hostname is defined %}\n      host: {{ ansible_hostname }}\n{% endif %}\n      job: containerslogs\n      __path__: /var/lib/docker/containers/*/*-json.log\n\n- job_name: DaemonLog\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n{% if ansible_hostname is defined %}\n      host: {{ ansible_hostname }}\n{% endif %}\n      job: daemon\n      __path__: /var/log/daemon.log\n\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Si vous n'\xeates pas \xe0 l'aise avec des templates Jinja2, vous trouverez une version \"pure\" de la config ",(0,r.kt)("a",{parentName:"em",href:"https://git.thoughtless.eu/Cinabre/rolePromtailAgent/src/branch/master/README.md"},"ici"))),(0,r.kt)("p",null,'Vous pouvez bien \xe9videmment adapter cette template \xe0 vos besoins. Mon id\xe9e premi\xe8re est d\'avoir une "base" que je peux mettre sur chaque machine ',(0,r.kt)("em",{parentName:"p"},"(sachant aussi que si aucun log n'est disponible, Promtail ne causera pas une erreur en ne trouvant pas les fichiers)")," "),(0,r.kt)("p",null,"Une fois Promtail configur\xe9, on peut le d\xe9marrer."),(0,r.kt)("p",null,"via l'executable directement : "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"/opt/promtail/promtail -config.file /opt/promtail/promtail-local-config.yaml\n")),(0,r.kt)("p",null,"ou via systemd ",(0,r.kt)("em",{parentName:"p"},"(automatique si vous passez par mon role Ansible)")," :",(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("inlineCode",{parentName:"p"},"systemctl start promtail")," "),(0,r.kt)("p",null,"Une fois cet agent install\xe9 sur vos machines, nous pouvons d'ores et d\xe9j\xe0 lancer des recherches sur Grafana."),(0,r.kt)("h3",{id:"faire-des-requetes-\xe0-loki-depuis-grafana"},"Faire des requetes \xe0 Loki depuis Grafana"),(0,r.kt)("p",null,'Sur Grafana, nous avons un onglet "Explore". Celui-ci va nous donner acc\xe8s \xe0 Loki en \xe9crivant des requetes, celles-ci sont assez simples, et surtout en utilisant l\'outil "click-o-drome" en d\xe9pliant le ',(0,r.kt)("em",{parentName:"p"},"Log Browser"),"\n",(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/UNL2s6m.png",alt:null})),(0,r.kt)("p",null,"Avec la template que je vous ai donn\xe9, vous aurez 4 jobs : "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"daemon"),(0,r.kt)("li",{parentName:"ul"},"authlog"),(0,r.kt)("li",{parentName:"ul"},"syslog"),(0,r.kt)("li",{parentName:"ul"},"containersjobs")),(0,r.kt)("p",null,"Ces jobs permettent de trier les logs. Nous allons donc s\xe9lectionner la machine ",(0,r.kt)("em",{parentName:"p"},'"Ansible"'),", puis demander le job ",(0,r.kt)("em",{parentName:"p"},'"authlog"'),".\nJe commence par cliquer sur Ansible, puis Authlog. Grafana me proposera exactement si je souhaite choisir un fichier sp\xe9cifique. Si on ne pr\xe9cise pas de fichier(",(0,r.kt)("em",{parentName:"p"},"filename"),") Grafana prendra tous les fichiers ",(0,r.kt)("em",{parentName:"p"},"(donc aucune importance si nous n'avons qu'un seul fichier)")," "),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"(vous remarquerez plus tard que d\xe8s notre 1ere s\xe9lection, grafana va cacher les jobs/h\xf4te/fichier qui ne concernent pas notre d\xe9but de requ\xeate)")," "),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/MWFQCyl.png",alt:null})),(0,r.kt)("p",null,"En validant notre requ\xeate (",(0,r.kt)("em",{parentName:"p"},"bouton ",(0,r.kt)("strong",{parentName:"em"},"show logs")),")"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/RCpb5GI.png",alt:null})),(0,r.kt)("p",null,"Nous avons alors le r\xe9sultat de la requ\xeate vers Loki dans le lapse de temps configur\xe9 dans Grafana (1h pour moi)."),(0,r.kt)("p",null,"Nous allons maintenant commencer \xe0 ",(0,r.kt)("strong",{parentName:"p"},"trier")," nos logs !"),(0,r.kt)("p",null,'En cliquant sur le petit "',(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"?")),'" au dessus de notre requete, nous avons une\n"cheatsheet" r\xe9sumant les fonctions basiques de Loki.\nNous d\xe9couvrons comment faire une recherche exacte avec ',(0,r.kt)("em",{parentName:"p"},"|="),", comment ignorer\nles lignes avec ",(0,r.kt)("em",{parentName:"p"},"!=")," et comment utiliser une expression reguli\xe8re avec ",(0,r.kt)("em",{parentName:"p"},"|~")),(0,r.kt)("p",null,"Je vous partage \xe9galement une cheatsheet un peu plus compl\xe8te que j'ai trouv\xe9\nsur un blog : ",(0,r.kt)("a",{parentName:"p",href:"https://megamorf.gitlab.io/cheat-sheets/loki/"},"ici")," "),(0,r.kt)("p",null,"Ainsi, on peut directement obtenir des logs un peu plus color\xe9s qui nous permettrons de cibler l'essentiel ! "),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/HzTwmwW.png",alt:null})),(0,r.kt)("p",null,"(L'id\xe9e est de cibler les logs sympas avec les couleurs qui vont avec) "),(0,r.kt)("h2",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"Si on entend souvent parler de la suite ELK, \xe7a n'est pas non-plus une raison pour s'en servir \xe0 tout prix ! Loki est une bonne alternative proposant des fonctionnalit\xe9s basiques qui suffiront pour la plupart."))}c.isMDXComponent=!0}}]);