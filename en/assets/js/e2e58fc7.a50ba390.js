"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[989],{4137:(e,t,n)=>{n.d(t,{Zo:()=>h,kt:()=>d});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),u=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},h=function(e){var t=u(e.components);return o.createElement(s.Provider,{value:t},e.children)},c="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,h=i(e,["components","mdxType","originalType","parentName"]),c=u(n),m=a,d=c["".concat(s,".").concat(m)]||c[m]||p[m]||r;return n?o.createElement(d,l(l({ref:t},h),{},{components:n})):o.createElement(d,l({ref:t},h))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[c]="string"==typeof e?e:a,l[1]=i;for(var u=2;u<r;u++)l[u]=n[u];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3584:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>i,toc:()=>u});var o=n(7462),a=(n(7294),n(4137));const r={slug:"longhorn",title:"Longhorn, stockage distribu\xe9",authors:{name:"TheBidouilleur",title:"Adorateur de trucs merdiques",url:"https://github.com/qjoly/",image_url:"https://avatars.githubusercontent.com/u/82603435?v=4"},tags:["kubernetes"]},l=void 0,i={permalink:"/TheBidouilleur.xyz/en/blog/longhorn",editUrl:"https://github.com/QJoly/TheBidouilleur.xyz/tree/main/blog/2022-07-24-Longhorn/index.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/2022-07-24-Longhorn/index.md",title:"Longhorn, stockage distribu\xe9",description:"I'm in the middle of learning Kubernetes and solutions to manage a cluster, I'm practicing on a test cluster that has small containers on it like the one running thebidouilleur.xyz.",date:"2022-07-24T00:00:00.000Z",formattedDate:"July 24, 2022",tags:[{label:"kubernetes",permalink:"/TheBidouilleur.xyz/en/blog/tags/kubernetes"}],readingTime:3.715,hasTruncateMarker:!1,authors:[{name:"TheBidouilleur",title:"Adorateur de trucs merdiques",url:"https://github.com/qjoly/",image_url:"https://avatars.githubusercontent.com/u/82603435?v=4",imageURL:"https://avatars.githubusercontent.com/u/82603435?v=4"}],frontMatter:{slug:"longhorn",title:"Longhorn, stockage distribu\xe9",authors:{name:"TheBidouilleur",title:"Adorateur de trucs merdiques",url:"https://github.com/qjoly/",image_url:"https://avatars.githubusercontent.com/u/82603435?v=4",imageURL:"https://avatars.githubusercontent.com/u/82603435?v=4"},tags:["kubernetes"]},prevItem:{title:"Mes d\xe9buts \xe0 la gyroroue",permalink:"/TheBidouilleur.xyz/en/blog/gyroroue"},nextItem:{title:"Mes d\xe9buts avec s3",permalink:"/TheBidouilleur.xyz/en/blog/s3contabo"}},s={authorsImageUrls:[void 0]},u=[{value:"What is Longhorn?",id:"what-is-longhorn",level:2},{value:"Concrete values",id:"concrete-values",level:3},{value:"Comment d\xe9ployer Longhorn ?",id:"comment-d\xe9ployer-longhorn-",level:2},{value:"How to deploy Longhorn ?",id:"how-to-deploy-longhorn-",level:2},{value:"Putting Longhorn into practice",id:"putting-longhorn-into-practice",level:2},{value:"Conclusion",id:"conclusion",level:2}],h={toc:u},c="wrapper";function p(e){let{components:t,...r}=e;return(0,a.kt)(c,(0,o.Z)({},h,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"I'm in the middle of learning Kubernetes and solutions to manage a cluster, I'm practicing on a test cluster that has small containers on it like the one running ",(0,a.kt)("em",{parentName:"p"},"thebidouilleur.xyz"),"."),(0,a.kt)("p",null,"Longhorn is a must-have in the Kubernetes universe ",(0,a.kt)("em",{parentName:"p"},"(and in particular ",(0,a.kt)("strong",{parentName:"em"},"k3s"),")"),", I couldn't continue learning without dwelling on Longhorn.\nBut first things first."),(0,a.kt)("h2",{id:"what-is-longhorn"},"What is Longhorn?"),(0,a.kt)("p",null,"Longhorn is presented in this simple sentence:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Longhorn is a lightweight, reliable and easy-to-use distributed block storage system for Kubernetes.")),(0,a.kt)("p",null,"But we can go a little further than this simple sentence...\nLonghorn is a centralized storage system between cluster nodes. This means that instead of using an external storage like an NFS ",(0,a.kt)("em",{parentName:"p"},"(",(0,a.kt)("a",{parentName:"em",href:"https://kubernetes.io/docs/concepts/storage/storage-classes/"},"or other, here is the list of possibilities"))," we will be able to keep the data internally by using the disks of our machines present in the cluster."),(0,a.kt)("p",null,"And if you ask yourself the same question as me before knowing : Longhorn will make the equivalent of a RAID 0 by replicating the data on several nodes to avoid that the loss of a machine leads to the loss of data."),(0,a.kt)("h3",{id:"concrete-values"},"Concrete values"),(0,a.kt)("p",null,"For example, counting the disks of my nodes I have 4x32Gio and 1x16Gio, that is 144Gio ",(0,a.kt)("em",{parentName:"p"},"( or 132Go because Rancher uses this value )"),".\nOf these 132GB, I currently occupy 36, I can use 56 on Longhorn, and I have 40 reserved for replicas. ",(0,a.kt)("em",{parentName:"p"},"(by default, Rancher generates 3 replicas)")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Dashboard longhorn",src:n(2125).Z,width:"2560",height:"887"}),"  "),(0,a.kt)("h2",{id:"comment-d\xe9ployer-longhorn-"},"Comment d\xe9ployer Longhorn ?"),(0,a.kt)("h2",{id:"how-to-deploy-longhorn-"},"How to deploy Longhorn ?"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://longhorn.io/docs/1.3.0/deploy/install/"},(0,a.kt)("em",{parentName:"a"},"link to official documentation"))),(0,a.kt)("p",null,"You can deploy Longhorn using Helm, the Rancher catalog or just through Kubectl"),(0,a.kt)("p",null,"  kubectl apply -f ",(0,a.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/longhorn/longhorn/v1.3.0/deploy/longhorn.yaml"},"https://raw.githubusercontent.com/longhorn/longhorn/v1.3.0/deploy/longhorn.yaml")),(0,a.kt)("admonition",{title:"Version !",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Be careful, this command will only deploy version ",(0,a.kt)("strong",{parentName:"p"},"1.3.0")," of longhorn, remember to get the last link in the documentation ",(0,a.kt)("em",{parentName:"p"},"(or edit the link I put)")),(0,a.kt)("p",{parentName:"admonition"},"As a security measure, you should always check the contents in the applied yaml. Remember to take a look!")),(0,a.kt)("p",null,"You'll have to wait until the pods deploy to start using Longhorn.\nTo check the real time status, the documentation suggests the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods \\\n--namespace longhorn-system \\\n--watch\n")),(0,a.kt)("p",null,"But you can use ",(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"https://k9scli.io/"},"k9s"))," as well."),(0,a.kt)("p",null,"Once OK, we can deploy our first pod linked to longhorn."),(0,a.kt)("h2",{id:"putting-longhorn-into-practice"},"Putting Longhorn into practice"),(0,a.kt)("p",null,"Here is the manifest that we will deploy to use a volume in longhorn:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: longhorn-nginx-thebidouilleur-demo\nspec:\n  accessModes:\n    - ReadWriteOnce\n  storageClassName: longhorn\n  resources:\n    requests:\n      storage: 1Gi\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: longhorn-thebidouilleur-demo\n  namespace: default\nspec:\n  containers:\n    - name: block-volume-test\n      image: nginx:stable-alpine\n      imagePullPolicy: IfNotPresent\n      volumeMounts:\n        - name: volume-longhorn\n          mountPath: "/usr/share/nginx/html"\n      ports:\n        - containerPort: 80\n  volumes:\n    - name: volume-longhorn\n      persistentVolumeClaim:\n        claimName: longhorn-nginx-thebidouilleur-demo \n')),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Volume OK",src:n(9619).Z,width:"2560",height:"269"})),(0,a.kt)("p",null,"We ask for 1Gio to be allocated to this volume ",(0,a.kt)("em",{parentName:"p"},"(it will influence the storage allocated for replicas)")," and we deploy a classic nginx.\nOnce deployed, we will open a tunnel to this pod:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl port-forward longhorn-thebidouilleur-demo 8080:80\n")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"}," Knowing that the tunnel must open on your ",(0,a.kt)("strong",{parentName:"p"},"local")," machine ",(0,a.kt)("em",{parentName:"p"},"(and not on one of the cluster nodes)"),".\nI invite you to consult ",(0,a.kt)("a",{parentName:"p",href:"https://google.com"},"this page")," put kubectl on your machine.")),(0,a.kt)("p",null,"and if we query the nginx, we obviously get a 403 error because the longhorn folder is empty.\nSo we will create our ",(0,a.kt)("em",{parentName:"p"},"index.html")," file directly from the pod."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl exec longhorn-thebidouilleur-demo -i -t -- /bin/sh\necho "Hello World" > /usr/share/nginx/html/index.html\n')),(0,a.kt)("p",null,"And by re-interrogating our pod: we find our ",(0,a.kt)("em",{parentName:"p"},"Hello World"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[thebidouilleur@bertha ~]$ curl localhost:8080\nHello World\n")),(0,a.kt)("p",null,"Now... it's very nice but do we keep our page in case of deletion of the pod?"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl delete pod longhorn-thebidouilleur-demo\n")),(0,a.kt)("p",null,"We can see that on the longhorn dashboard: the volume has been switched to deattach. *(which means that the data are still present but not used on a pod)"),(0,a.kt)("p",null,"We will re-apply the same manifest to recreate our pod and redo the same tunnel to access the nginx"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"[thebidouilleur@bertha ~]$ curl localhost:8080\nHello World\n")),(0,a.kt)("p",null,'We have our "Hello World" page back!'),(0,a.kt)("h2",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"Longhorn is an extremely easy to use tool that allows you to avoid creating an external solution to the cluster that would be less practical to manage. I didn't go very far in its features either and I let you make your own opinion for ",(0,a.kt)("em",{parentName:"p"},"longhorn in production")," (and for that, go see the article of the site ",(0,a.kt)("a",{parentName:"p",href:"https://easyadmin.tech/longhorn-solution-volumes-kubernetes-production"},(0,a.kt)("em",{parentName:"a"},"easyadmin.tech")),")\nLonghorn is welcome in my test Homelab and will be in the center of it !"))}p.isMDXComponent=!0},2125:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/dashboard_longhorn-7c92862a7937802377287eaf60c70ccd.png"},9619:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/volume_ok-c0573dc9cd462575227d4290931907f9.png"}}]);