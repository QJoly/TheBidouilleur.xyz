<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">5 posts tagged with &quot;docker&quot; | TheBidouilleur</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/img/BMO.png"><meta data-rh="true" name="twitter:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/img/BMO.png"><meta data-rh="true" property="og:url" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/tags/docker"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" name="keywords" content="blog, thebidouilleur, informatique, devops, the bidouilleur, kubernetes, docker, ansible, infra-as-code"><meta data-rh="true" property="og:title" content="5 posts tagged with &quot;docker&quot; | TheBidouilleur"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/TheBidouilleur.xyz/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/tags/docker"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/tags/docker" hreflang="en"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/tags/docker" hreflang="fr"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/tags/docker" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TheBidouilleur.xyz/en/blog/rss.xml" title="TheBidouilleur RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TheBidouilleur.xyz/en/blog/atom.xml" title="TheBidouilleur Atom Feed">




<script src="https://stats.192168128.xyz/js/script.js" defer="defer" data-domain="thebidouilleur.xyz"></script><link rel="stylesheet" href="/TheBidouilleur.xyz/en/assets/css/styles.a16b7bf2.css">
<link rel="preload" href="/TheBidouilleur.xyz/en/assets/js/runtime~main.3337d4b0.js" as="script">
<link rel="preload" href="/TheBidouilleur.xyz/en/assets/js/main.c6b24396.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TheBidouilleur.xyz/en/"><div class="navbar__logo"><img src="/TheBidouilleur.xyz/en/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--light_HNdA"><img src="/TheBidouilleur.xyz/en/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TheBidouilleur</b></a><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TheBidouilleur.xyz/en/blog">Blog</a><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/TheBidouilleur.xyz/en/blog/tags/docker" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/TheBidouilleur.xyz/blog/tags/docker" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Français</a></li></ul></div><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/en/blog/archive">Archives</a><a href="https://twitter.com/thebidouilleur" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Articles</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/QuteBrowser">QuteBrowser - Un navigateur basé sur Vim</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/ipfs">IPFS - un protocole pour archiver et partager des fichiers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/DebianRepository">Simple DebianRepository - Déployer un dépôt Debian en 2min</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/dagger">Dagger.io, un CI Universel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/abuseipdb-fail2ban">Signalez vos attaquants avec Fail2Ban</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/Mon-Setup">Mon matériel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/Creer-son-registre-helm">Créer son propre registre helm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/kubernetes-hcl">Kubernetes in HCL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/cluster-maj">Keep your clusters up-to-date</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/remarkable">Remarkable, a step forward in note taking</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/nixos">NixOS, Ma nouvelle distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/gyroroue">Mes débuts à la gyroroue</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/longhorn">Longhorn, stockage distribué</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/s3contabo">Mes débuts avec s3</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/presentation-packer">Quick Presentation of Packer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/traefik">Traefik, le reverse-proxy multi-provider</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/loki-grafana">Utilisation de Loki pour Centraliser les logs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/caddy">Too many loadbalancers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/presentation-docker-swarm">Quick presentation of Docker Swarm</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>5 posts tagged with &quot;docker&quot;</h1><a href="/TheBidouilleur.xyz/en/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/dagger">Dagger.io, un CI Universel</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-31T00:00:00.000Z" itemprop="datePublished">March 31, 2023</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Dagger.io est un projet qui a été annoncé il y a quelque temps par Solomon Hykes, la philosophie de Dagger a attiré mon attention.</p><p>C&#x27;est un service de CI/CD qui permet de lancer des jobs dans des conteneurs Docker. La plus-value de Dagger est qu&#x27;il ne se limite pas à du Yaml <em>(Comme Gitlab-CI, Github Action, Drone.io)</em> ou à un DSL maison <em>(Comme Jenkins)</em>, il permet de lancer des jobs en utilisant du code Python, du Go, du Java.Typescript ou encore du GraphQL.</p><p>Il est un peu comme Pulumi mais pour les jobs de CI/CD. <em>(Là où son concurrent Terraform utilise un DSL, Pulumi utilise le Typescript, Python, Java, etc)</em></p><p>Étant donné que j&#x27;utilise Github pour mes projets publics, Gitea pour mes projets privés <em>(couplé à Drone)</em> et Gitlab pour les projets professionnels, je me suis dit que c&#x27;était l&#x27;occasion de tester Dagger.io et de me débarrasser de mes fichiers Yaml ayant une syntaxe différente en fonction de la plateforme.</p><p>Mon idée derrière la conversion de mes jobs de CI/CD en code est également d&#x27;avoir les <strong>mêmes</strong> résultats entre les différentes plateformes et ma machine locale.</p><p>On va donc faire le point sur ce qu&#x27;est Dagger.io, comment l&#x27;installer et comment l&#x27;utiliser. Comme je suis habitué au langage Python, j&#x27;utiliserai alors le SDK Python de Dagger.io !</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation-de-daggerio">Installation de Dagger.io<a href="#installation-de-daggerio" class="hash-link" aria-label="Direct link to Installation de Dagger.io" title="Direct link to Installation de Dagger.io">​</a></h2><p>Il sera nécessaire d&#x27;avoir un Python 3.10 ou supérieur pour utiliser Dagger.io <em>(il est aussi possible d&#x27;utiliser un <a href="https://packaging.python.org/en/latest/tutorials/installing-packages/#creating-virtual-environments" target="_blank" rel="noopener noreferrer">venv</a>)</em>.</p><p>Pour installer Dagger.io, il n&#x27;y a rien de bien compliqué, il suffit d&#x27;installer le package via pip.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pip </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> dagger-io</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Et c&#x27;est terminé pour l&#x27;installation.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> <code>ERROR: Could not find a version that satisfies the requirement dagger-io (from versions: none)</code></summary><div><div class="collapsibleContent_i85q"><p>Si vous avez une erreur de ce type :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">➜  ~ python3 -m pip </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> dagger-io </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Defaulting to user installation because normal site-packages is not writeable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Collecting dagger-io</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Using cached dagger_io-0.4.2-py3-none-any.whl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">52</span><span class="token plain"> kB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Collecting cattrs</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">22.2</span><span class="token plain">.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Using cached mdurl-0.1.2-py3-none-any.whl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10.0</span><span class="token plain"> kB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Collecting multidict</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">4.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Using cached multidict-6.0.4-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">114</span><span class="token plain"> kB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ERROR: Exception:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Traceback </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">most recent call last</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  File </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/usr/lib/python3/dist-packages/pip/_internal/cli/base_command.py&quot;</span><span class="token plain">, line </span><span class="token number" style="color:rgb(247, 140, 108)">165</span><span class="token plain">, </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> exc_logging_wrapper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    status </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> run_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">*args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  File </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/usr/lib/python3/dist-packages/pip/_internal/cli/req_command.py&quot;</span><span class="token plain">, line </span><span class="token number" style="color:rgb(247, 140, 108)">205</span><span class="token plain">, </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> wrapper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">return</span><span class="token plain"> func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">self, options, args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  File </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/usr/lib/python3/dist-packages/pip/_internal/commands/install.py&quot;</span><span class="token plain">, line </span><span class="token number" style="color:rgb(247, 140, 108)">389</span><span class="token plain">, </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    to_install </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> resolver.get_installation_order</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">requirement_set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  File </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/usr/lib/python3/dist-packages/pip/_internal/resolution/resolvelib/resolver.py&quot;</span><span class="token plain">, line </span><span class="token number" style="color:rgb(247, 140, 108)">188</span><span class="token plain">, </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> get_installation_order</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    weights </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> get_topological_weights</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  File </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/usr/lib/python3/dist-packages/pip/_internal/resolution/resolvelib/resolver.py&quot;</span><span class="token plain">, line </span><span class="token number" style="color:rgb(247, 140, 108)">276</span><span class="token plain">, </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> get_topological_weights</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">weights</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> expected_node_count</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AssertionError</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Il se peut que vous ayez une version trop ancienne de pip et setuptools. La solution est de mettre à jour pip et setuptools via la commande suivante :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pip </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> --upgrade pip setuptools</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>Si vous ne souhaitez pas travailler avec l&#x27;utilisateur root, il vous faudra configurer le mode Rootless de Docker. <em>(C&#x27;est ce que j&#x27;ai fait)</em> Pour cela, il suffit de suivre la <a href="https://docs.docker.com/engine/security/rootless/" target="_blank" rel="noopener noreferrer">documentation officielle</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="premier-job">Premier job<a href="#premier-job" class="hash-link" aria-label="Direct link to Premier job" title="Direct link to Premier job">​</a></h2><p>Pour commencer, nous allons créer un fichier <code>hello-world.py</code> et y ajouter le code suivant :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token triple-quoted-string string" style="color:rgb(195, 232, 141)">&quot;&quot;&quot;Execute a command.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> sys</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> anyio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> dagger</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Connection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">log_output</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stderr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        python </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;python:3.11-slim-buster&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;python&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-V&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        version </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> python</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stdout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string-interpolation string" style="color:rgb(195, 232, 141)">f&quot;Hello from Dagger and </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string-interpolation interpolation">version</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token string-interpolation string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;__main__&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    anyio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Il s&#x27;agit d&#x27;un simple job qui va lancer un conteneur Docker avec l&#x27;image <code>python:3.11-slim-buster</code> et exécuter la commande <code>python -V</code>.</p><p>Pour lancer le job, il suffit de lancer avec python : <code>python3 hello-world.py</code>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">➜  python3 hello-world.py    </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#1 resolve image config for docker.io/library/python:3.11-slim-buster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#1 DONE 1.7s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#2 importing cache manifest from dagger:10686922502337221602</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#2 DONE 0.0s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#3 DONE 0.0s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 from python:3.11-slim-buster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 resolve docker.io/library/python:3.11-slim-buster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 resolve docker.io/library/python:3.11-slim-buster 0.2s done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 sha256:f0712d0bdb159c54d5bdce952fbb72c5a5d2a4399654d7f55b004d9fc01e189e 0B / 3.37MB 0.2s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 sha256:f0712d0bdb159c54d5bdce952fbb72c5a5d2a4399654d7f55b004d9fc01e189e 3.37MB / 3.37MB 0.3s done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 extracting sha256:80384e04044fa9b6493f2c9012fd1aa7035ab741147248930b5a2b72136198b1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 extracting sha256:80384e04044fa9b6493f2c9012fd1aa7035ab741147248930b5a2b72136198b1 0.3s done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 extracting sha256:f0712d0bdb159c54d5bdce952fbb72c5a5d2a4399654d7f55b004d9fc01e189e</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 extracting sha256:f0712d0bdb159c54d5bdce952fbb72c5a5d2a4399654d7f55b004d9fc01e189e 0.2s done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#3 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#3 0.224 Python 3.11.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#3 DONE 0.3s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#4 from python:3.11-slim-buster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Hello from Dagger and Python </span><span class="token number" style="color:rgb(247, 140, 108)">3.11</span><span class="token plain">.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Félicitations, vous avez lancé votre premier job avec Dagger.io !</p><p>Maintenant, nous allons voir comment créer un script un peu plus complexe !</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dagger-python-et-docker">Dagger, Python et Docker<a href="#dagger-python-et-docker" class="hash-link" aria-label="Direct link to Dagger, Python et Docker" title="Direct link to Dagger, Python et Docker">​</a></h2><p>Jusque-là, nous n&#x27;avons pas beaucoup profité de la puissance de Python, ou même des fonctionnalités de Docker. Nous allons donc voir comment utiliser les deux ensemble.</p><p>Vous n&#x27;êtes pas sans savoir que j&#x27;utilise <em>Docusaurus</em> pour générer le code HTML que vous visionnez en ce moment même. Docusaurus me permet d&#x27;écrire mes articles en Markdown et de les transformer en site.</p><p>N&#x27;étant pas très regardant sur la qualité de mes Markdown, j&#x27;ai décidé de créer un job qui va vérifier la syntaxe de mes fichiers Markdown et me renvoyer une erreur s&#x27;il y a un problème sur l&#x27;un d&#x27;entre eux.</p><p>Pour cela, je vais utiliser <a href="https://pypi.org/project/pymarkdownlnt/" target="_blank" rel="noopener noreferrer">pymarkdownlnt</a>, un Linter assez strict et performant.</p><p>Son installation se fait via pip :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pip </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> pymarkdownlnt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ainsi, notre job va devoir effectuer ces étapes de manière séquentielle :</p><ul><li>Démarrer à partir d&#x27;une image Python <em>(<code>FROM python:3.10-slim-buster</code>)</em></li><li>Installer pymarkdownlnt <em>(<code>RUN pip install pymarkdownlnt</code>)</em></li><li>Récupérer les fichiers du projet <em>(<code>COPY . .</code>)</em></li><li>Lancer le linter sur les fichiers Markdown de chaque dossier <em>blog/ docs/ i18n/</em> (<code>RUN pymarkdownlnt scan blog/-r</code>)</li></ul><p>Nous pouvons traduire les 3 premières étapes en code Python :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">lint </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;python:3.10-slim-buster&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pip install pymarkdownlnt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">split</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot; &quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_mounted_directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/data&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> src</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_workdir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/data&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Et ensuite… je souhaite faire une boucle itérant sur les dossiers <code>blog/ docs/ i18n/</code> et lancer le linter sur chacun d&#x27;entre eux. C&#x27;est à ce moment précis que nous allons utiliser du Python et plus uniquement des instructions Dagger.</p><p>Un détail que je ne vous ai pas encore mentionné, c&#x27;est que nous pouvons agir sur notre job tant qu&#x27;il n&#x27;est pas lancé, c&#x27;est-à-dire avant le <code>await</code> qui va attendre la fin de l&#x27;exécution du job.</p><p>Donc… gardons la définition du conteneur ci-dessus, et ajoutons 3 tâches à notre job :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;blog&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;docs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;i18n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  lint </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pymarkdownlnt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scan&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-r&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Plutôt simple, non ?</p><p>Si je lance mon job, j&#x27;ai de nombreuses erreurs à propos de règles que je n&#x27;ai pas respectées. Mais c&#x27;est normal, la syntaxe de Docusaurus cause des erreurs dans le linter que je ne peux pas corriger.</p><p>Je vais donc noter les règles qui ne s&#x27;appliquent pas à mes fichiers, et les ignorer :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">lint_rules_to_ignore </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD013&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD003&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD041&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD022&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD023&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD033&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD019&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Format accepté par pymarkdownlint : &quot;MD013,MD003,MD041,MD022,MD023,MD033,MD019&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;blog&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;docs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;i18n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  lint </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pymarkdownlnt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-d&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">str</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;,&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">lint_rules_to_ignore</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scan&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-r&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Voici notre script complet :</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token triple-quoted-string string" style="color:rgb(195, 232, 141)">&quot;&quot;&quot;Markdown linting script.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> sys</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> anyio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> dagger</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> threading</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">markdown_lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    lint_rules_to_ignore </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD013&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD003&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD041&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD022&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD023&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD033&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;MD019&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Connection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">log_output</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stderr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        src </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        lint </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">from_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;python:3.10-slim-buster&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pip install pymarkdownlnt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">split</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot; &quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_mounted_directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/data&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> src</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_workdir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/data&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;blog&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;docs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;i18n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            lint </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">with_exec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pymarkdownlnt&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-d&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">str</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;,&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">lint_rules_to_ignore</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scan&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-r&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># execute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stdout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string-interpolation string" style="color:rgb(195, 232, 141)">f&quot;Markdown lint is FINISHED!&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;__main__&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        anyio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">markdown_lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">except</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Error in Linting&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Après cette modification, mon job fonctionne sans problème !</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">python3 .ci/markdown_lint.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><script async="" id="asciicast-zZKfJU9fIWBexQYGv8xI0X51P" src="https://asciinema.org/a/zZKfJU9fIWBexQYGv8xI0X51P.js"></script><p>Récapitulons ce que nous savons faire :</p><ul><li>Lancer une image Docker</li><li>Exécuter des commandes dans un conteneur</li><li>Copier des fichiers depuis l&#x27;hôte vers le conteneur</li></ul><p>Je pense que ça suffira dans la plupart de mes CI. Néanmoins, il reste une fonctionnalité qui me manque : la possibilité de construire une image Docker et de l&#x27;envoyer sur un registre.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="build--push-dune-image-docker">Build &amp; push d&#x27;une image Docker<a href="#build--push-dune-image-docker" class="hash-link" aria-label="Direct link to Build &amp; push d&#x27;une image Docker" title="Direct link to Build &amp; push d&#x27;une image Docker">​</a></h2><p>Il est possible de s&#x27;authentifier sur un registre directement via Dagger. Dans mon cas, je considère que l&#x27;hôte sur lequel je lance mon job est <strong>déjà</strong> authentifié.</p><p>Dans le cadre de cette démonstration, je vais utiliser le registre <code>ttl.sh</code>, un registre public et anonyme permettant justement de stocker des images Docker pendant une durée maximale de 24h.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">docker_image_build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Connection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">log_output</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stderr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        src </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        build </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                context </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> src</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                dockerfile </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Dockerfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                build_args</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">BuildArg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;APP&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;APP&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;TheBidouilleurxyz&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        image </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> blog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ttl.sh/thebidouilleur:1h&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Le code ci-dessus va donc construire mon image Docker à partir du fichier <code>Dockerfile</code> présent dans le dossier courant, et l&#x27;envoyer sur le registre <code>ttl.sh/thebidouilleur:1h</code>.</p><p>Une petite particularité de ce code est l&#x27;usage de <em>Build Args</em>. J&#x27;utilise la variable d&#x27;environnement <code>APP</code>, si cette variable n&#x27;est pas définie, je vais récupérer la valeur par défaut <code>TheBidouilleurxyz</code>.</p><script async="" id="asciicast-JA71Nlp9ZOvIndye9QA8QoEtU" src="https://asciinema.org/a/JA71Nlp9ZOvIndye9QA8QoEtU.js"></script><p>Maintenant, je souhaite créer un job similaire qui va construire une image Docker multiarchitecture <em>ARM et AMD64 (l&#x27;un de mes clusters Kubernetes est composé de Raspberry Pi).</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="build--push-dune-image-docker-multiarchitecture">Build &amp; push d&#x27;une image Docker multiarchitecture<a href="#build--push-dune-image-docker-multiarchitecture" class="hash-link" aria-label="Direct link to Build &amp; push d&#x27;une image Docker multiarchitecture" title="Direct link to Build &amp; push d&#x27;une image Docker multiarchitecture">​</a></h2><p>Il faudra déjà mettre au point le build multiarchitecture sur votre machine avant de pouvoir l&#x27;intégrer à notre job Dagger.</p><p>Si vous souhaitez savoir comment créer une image Docker multiarchitecture, je vous invite à lire ma documentation <a href="/TheBidouilleur.xyz/en/docs/Adminsys/MultiArch-Build/">Création image Docker</a> pour en connaitre la procédure.</p><p>On va utiliser un objet à mettre en paramètre à Dagger, celui-ci est <code>dagger.Platform</code> et permet de spécifier la plateforme sur laquelle on veut construire notre image Docker.</p><p>Nous créons une boucle qui va itérer sur les différentes architectures avec lesquelles on veut construire notre image, et lors du Publish, nous enverrons les différentes images construites.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">docker_image_build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  platforms </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;linux/amd64&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;linux/arm64&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Connection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">log_output</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sys</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">stderr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    src </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    variants </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> platform </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> platforms</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string-interpolation string" style="color:rgb(195, 232, 141)">f&quot;Building for </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string-interpolation interpolation">platform</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token string-interpolation string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      platform </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> dagger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Platform</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">platform</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      build </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">platform</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">platform</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                context </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> src</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                dockerfile </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Dockerfile&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      variants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">container</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">publish</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ttl.sh/dagger_test:1h&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> platform_variants</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">variants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Docker avec plusieurs architectures" src="/TheBidouilleur.xyz/en/assets/images/multiarch-7c35139b00bd7f7e4ae8c48bf22f2738.png" width="1280" height="208" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="créer-un-lanceur">Créer un lanceur<a href="#créer-un-lanceur" class="hash-link" aria-label="Direct link to Créer un lanceur" title="Direct link to Créer un lanceur">​</a></h2><p>Maintenant que nous avons vu comment utiliser Dagger, nous allons créer un lanceur qui va nous permettre de lancer nos jobs un-par-un.</p><p>Pour lancer nos taches en asynchrone, nous utilisons la librairie <a href="https://anyio.readthedocs.io/en/stable/" target="_blank" rel="noopener noreferrer">anyio</a> sur chacun de nos scripts.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> anyio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> markdown_lint </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> docusaurus_build </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> multi_arch_build </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> docker_build</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;__main__&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Running tests in parallel using anyio&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        anyio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">markdown_lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">markdown_lint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        anyio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">docusaurus_build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">docusaurus_build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        anyio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">docker_build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">docker_build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ce lanceur va importer les méthodes des fonctions <code>markdown_lint</code>, <code>docusaurus_build</code> et <code>docker_build</code> des fichiers <code>markdown_lint.py</code>, <code>docusaurus_build.py</code> et <code>multi_arch_build.py</code> avant d&#x27;exécuter chacune de ces fonctions.</p><p>L&#x27;unique intérêt de ce lanceur est de pouvoir lancer nos jobs à partir d&#x27;une seule commande.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>Dagger est un produit très prometteur ! Celui-ci n&#x27;arrivera surement pas à remplacer les solutions actuelles telles que Github Actions ou Gitlab CI, mais il répond à un besoin spécifique : celui d&#x27;avoir le même CI peu importe la plateforme.</p><p>Bref, Dagger est un produit qui mérite d&#x27;être testé et je pense que je vais l&#x27;utiliser pour la plupart de mes projets personnels.</p><p>J&#x27;espère que cet article vous aura plu, n&#x27;hésitez pas à me faire part de vos retours.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/dagger">dagger</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/ci">ci</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">docker</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/cluster-maj">Keep your clusters up-to-date</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-11-10T00:00:00.000Z" itemprop="datePublished">November 10, 2022</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Since the DevOps movement started (or rather <em>Platform engineering</em>), the topic of high availability has been brought to the forefront. And one of the most versatile solutions to achieve high availability is to create application clusters. (and so: containers)</p><p>So I&#x27;ve been running a Swarm cluster for a few years and I recently switched to Kubernetes <em>(k3s to be precise)</em>. And by having clusters holding several hundreds of containers, we forget about maintenance and update.</p><p>And in this article, we will talk about updates.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="out-of-cluster-container-upgrade-solutions">Out-of-cluster container upgrade solutions<a href="#out-of-cluster-container-upgrade-solutions" class="hash-link" aria-label="Direct link to Out-of-cluster container upgrade solutions" title="Direct link to Out-of-cluster container upgrade solutions">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="watchtower">WatchTower<a href="#watchtower" class="hash-link" aria-label="Direct link to WatchTower" title="Direct link to WatchTower">​</a></h3><p>I think the best known solution is <a href="https://containrrr.dev/watchtower/" target="_blank" rel="noopener noreferrer">Watchtower</a></p><p>Watchtower is easy to use and is based (like many others) on <strong>labels</strong>. A label allows to define some parameters and to activate (or deactivate) the monitoring of updates.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Updating is not always good...</div><div class="admonitionContent_S0QG"><p>Be careful not to automatically update sensitive programs! We can&#x27;t check what an update and if they won&#x27;t break something.
It&#x27;s up to you to choose which applications to monitor, and to trigger an update or not.</p></div></div><p>WatchTower will notify you in several ways:</p><ul><li>email</li><li>slack</li><li>msteams</li><li>gotify</li><li>shoutrrr</li></ul><p>And among these methods, you do not have only proprietary solutions, free to you to host a shoutrrr, a gotify or to use your smtp so that this information does not leave your IS! *(I am very critical of the use of msteams, slack, discord to receive notifications)</p><p>WatchTower will scan for updates on a regular basis <em>(configurable)</em>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="container-updater-from-papamica">container-updater (from <a href="https://github.com/PAPAMICA" target="_blank" rel="noopener noreferrer">@PAPAMICA</a>)<a href="#container-updater-from-papamica" class="hash-link" aria-label="Direct link to container-updater-from-papamica" title="Direct link to container-updater-from-papamica">​</a></h3><p>The most provided/complex solution is not always the best. Papamica has set up a bash script to meet his specific needs <em>(which many other people must have)</em>: an update system notifying him through Discord and Zabbix.</p><p>This one is also based on labels and also takes care of the case where you want to update by docker-compose. (<em>instead of doing a docker pull, docker restart like Watchtower</em>)</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;autoupdate=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;autoupdate.docker-compose=/link/to/docker-compose.yml&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Even if I don&#x27;t use it, I had a time when I was using Zabbix and I needed to be notified on my Zabbix. <em>(which notified me by Mail/Gotify)</em></p><p>Papamica states that he plans to add private registry support <em>(for now only github registry or dockerhub)</em> as well as other notification methods.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solutions-for-swarm">Solutions for Swarm<a href="#solutions-for-swarm" class="hash-link" aria-label="Direct link to Solutions for Swarm" title="Direct link to Solutions for Swarm">​</a></h2><p>Swarm is probably the container orchestrator I enjoyed the most: it&#x27;s *<strong>*simple**</strong>! You learn fast, you discover fast and you get quick results.
But I&#x27;ve already written about Swarm in <a href="/TheBidouilleur.xyz/en/blog/presentation-docker-swarm/">another article</a>...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sheperd">Sheperd<a href="#sheperd" class="hash-link" aria-label="Direct link to Sheperd" title="Direct link to Sheperd">​</a></h3><p>What I like in Papamica&#x27;s program (and that goes with Sheperd) is that we keep bash as the central language. A language that we all know in the main thanks to Linux, and that we can read and modify if we take the time.</p><p>Shepherd&#x27;s code is only <a href="https://github.com/djmaze/shepherd/blob/master/shepherd" target="_blank" rel="noopener noreferrer">~200 lines</a> and works fine like that.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">shepherd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mazzolino/shepherd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> /var/run/docker.sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/var/run/docker.sock</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">placement</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">constraints</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> node.role == manager</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This one will accept several private registers, which gives a nice advantage compared to the other solutions presented.
Example:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> shepherd.enable=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> shepherd.auth.config=blog</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Shepherd does not include a <em>(default)</em> notification system. That&#x27;s why its creator decided to offer a <a href="https://github.com/djmaze/shepherd/blob/master/docker-compose.apprise.yml" target="_blank" rel="noopener noreferrer">Apprise sidecar as an alternative</a>. Which can redirect to many things like Telegram, SMS, Gotify, Mail, Slack, msteams etc....</p><p>I think this is the simplest and most versatile solution. I hope it will be found in other contexts. I hope it will be found in other contexts <em>(but I don&#x27;t go into too much detail on the subject, I&#x27;d like to write an article about it)</em>.</p><p>I used Shepherd for a long time and I had no problems.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solutions-for-kubernetes">Solutions for Kubernetes<a href="#solutions-for-kubernetes" class="hash-link" aria-label="Direct link to Solutions for Kubernetes" title="Direct link to Solutions for Kubernetes">​</a></h2><p>For Kubernetes, we start to lose in simplicity. Especially since with the <code>imagePullPolicy: Always</code> option, you just have to restart a pod to get the last image with the same <em>tag</em>.
For a long time, I used ArgoCD to update my configurations and re-deploy my images at each update on Git.</p><p>But ArgoCD is only used to <strong>update the configuration</strong> and not the image. The methodology is incorrect and it is necessary to find a suitable tool for that.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keelsh">Keel.sh<a href="#keelsh" class="hash-link" aria-label="Direct link to Keel.sh" title="Direct link to Keel.sh">​</a></h3><p>Keel is a tool that meets the same need: Update pod images. But it incorporates several features not found elsewhere.</p><p><img loading="lazy" src="https://keel.sh/img/keel_high_level.png" alt="Keel" class="img_ev3q"></p><p>If you want to keep the same operation as the alternatives <em>(i.e. regularly check for updates)</em>, it is possible:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">keel.sh/policy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> force</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">keel.sh/trigger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> poll</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">keel.sh/pollSchedule</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;@every 3m&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But where Keel excels is that it offers <strong>triggers</strong> and <strong>approvals</strong>.</p><p>A trigger is an event that will trigger the update of Keel. We can imagine a webhook coming from Github, Dockerhub, Gitea which will trigger the update of the server. *(So we avoid a regular crontab and we save resources, traffic and time)
As the use of webhook has become widespread in CICD systems, it can be coupled to many use cases.</p><p>The approvals are the little gem that was missing from the other tools. Indeed, I specified that <em>updating images is dangerous and you should not target sensitive applications in automatic updates</em>. And it&#x27;s just in response to that that Keel developed the <em>approvals</em>.</p><p><img loading="lazy" src="https://keel.sh/img/docs/approvals.png" alt="Approval system of keel" class="img_ev3q"></p><p>The idea is to give permission to Keel to update the pod. We can choose the moment and check manually.</p><p>I think it&#x27;s a pity that we have Slack or MSTeams imposed for the approvals, it&#x27;s then a feature that I won&#x27;t use.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>A UI</div><div class="admonitionContent_S0QG"><p>So for now, I use Keel without its web interface, it may bring new features, but I would like to avoid an umpteenth interface to manage.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>Updating a container is not that easy when you are looking for automation and security. If today, I find that Keel corresponds to my needs, I have the impression that the tools are similar without offering real innovations. <em>(I&#x27;m thinking of tackling the canary idea one day)</em>
I hope to discover new solutions soon, hoping that they will better fit my needs.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/swarm">swarm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/kubernetes">kubernetes</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/traefik">Traefik, le reverse-proxy multi-provider</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2022</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>L&#x27;année dernière, j&#x27;ai dit que j&#x27;appréciais particulièrement <strong>Caddy</strong> qui était simple, pratique, rapide et efficace. Caddy permet, à partir d&#x27;une ligne aussi simple que :</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">domain.tld </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  reverse_proxy </span><span class="token number" style="color:rgb(247, 140, 108)">127.0</span><span class="token plain">.</span><span class="token number" style="color:rgb(247, 140, 108)">0.1</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>En plus de ça, Caddy va constamment vérifier l&#x27;expiration de vos certificats letsencrypt et de les renouveler automatiquement sans aucune interaction nécéssaire.
Caddy est également facile à déployer via Docker.</p><p>Que demander de plus ?</p><blockquote><p>De l&#x27;automatisation ?</p></blockquote><p>Parfaitement, cher lecteur ! Vous m&#x27;étonnez toujours !
J&#x27;ai donc créé un Rôle Ansible générant ma configuration automatiquement à partir d&#x27;un dépôt Git avec les IP correspondant aux domaines que je souhaite utiliser.
Maintenant, à partir de ça, je peux faire un script Bash récupérant les ports de mes conteneurs, puis push sur mon Git les nouvelles redire….</p><blockquote><p>C&#x27;est une usine à gaz…</p></blockquote><p>Et vous avez raison ! Ce système est obsolète en quelques secondes lorsqu&#x27;on utilise un système de <em>service discovery</em> permettant de récupérer mes services et automatiser l&#x27;ajout de ces services sur mon g…. Bon d&#x27;accord, toujours &quot;<em>usine à gaz</em>&quot; !</p><p>Pas le choix, je vais devoir en conséquence remplacer Caddy par quelque chose d&#x27;autre. Et justement : je sais exactement le soft à utiliser.</p><p>Place à <strong>Traefik</strong>, le RP (Reverse proxy) multi-provider avec du service discovery.</p><p>Cet article sur <strong>Traefik</strong> est en cours de rédaction, vous pouvez me suivre sur <a href="https://twitter.com/TheBidouilleur" target="_blank" rel="noopener noreferrer">twitter</a> pour être au courant des prochaines écritures ainsi que mon avancement dans mes projets !</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="quest-ce-que-traefik-">Qu&#x27;est-ce que Traefik ?<a href="#quest-ce-que-traefik-" class="hash-link" aria-label="Direct link to Qu&#x27;est-ce que Traefik ?" title="Direct link to Qu&#x27;est-ce que Traefik ?">​</a></h2><p><img loading="lazy" src="https://i.imgur.com/XxOB7Fo.png" alt="logo de traefik" class="img_ev3q"></p><p>Comme expliqué juste au-dessus, Traefik est un reverse-proxy qui se démarque des autres par son systeme de provider et de middleware. Il ne réinvente pas la roue, mais il est particulièrement efficace lorsque l&#x27;on a un grand nombre de redirections à paramétrer ou que nous avons des règles qui changent régulièrement.</p><p><a href="https://www.ionos.fr/digitalguide/serveur/know-how/quest-ce-quun-reverse-proxy-le-serveur-reverse-proxy/" target="_blank" rel="noopener noreferrer"><em>si vous ignorez ce qu&#x27;est un reverse-proxy, je vous invite à consulter cet article de Ionos</em></a></p><p>Traefik n&#x27;est <strong>pas</strong> fait pour vous si :</p><ul><li>Vous n&#x27;utilisez pas Docker, Kubernetes ou Consul</li><li>Si vous avez peu de règles (et surtout si elles sont statiques)</li><li>Vous ne vous souciez pas d&#x27;automatiser votre RP</li></ul><p>et en revanche :
Traefik est <strong>fait</strong> pour vous si :</p><ul><li>Vos services sont répartis sur de nombreuses machines</li><li>Vous avez un Swarm / Kubernetes</li></ul><p>Traefik, ce n&#x27;est pas pour tout le monde. Mais il y a de nombreux cas, et de nombreux domaines où Traefik n&#x27;est pas employé alors qu&#x27;il le devrait.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="comment-fonctionne-traefik-">Comment fonctionne Traefik ?<a href="#comment-fonctionne-traefik-" class="hash-link" aria-label="Direct link to Comment fonctionne Traefik ?" title="Direct link to Comment fonctionne Traefik ?">​</a></h2><p>Traefik se base sur un système de <strong>Provider</strong>. Un Provider est un moyen de récupérer les fameuses règles &quot;domaine -&gt; IP&quot; de manière <em>automatique</em> (ou presque).
Par exemple, sur Caddy, notre provider (la manière dont on récupère notre configuration) est un simple fichier.
Notre seule manière d&#x27;automatiser Caddy se repose donc sur notre gestion de ce fichier. (le <strong>Caddyfile</strong>)</p><p>Et c&#x27;est justement cet unique provider qui va me faire pencher vers Traefik, qui possède une grande liste de provider. Parmis ces providers, nous avons :</p><ul><li>Docker</li><li>Kubernetes / Rancher</li><li>Redis</li><li>des Fichiers classiques</li><li>Une API Json</li></ul><p>et en fonction des providers que l&#x27;on accorde à Traefik(et du contenu), celui-ci va s&#x27;adapter pour créer les redirections de manière automatique.</p><p>Nous allons tester ça directement dans notre premier Traefik de test !
On va avant-tout créer le réseau Docker qui permettra à notre reverse-proxy d&#x27;accéder aux conteneurs.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> network create --driver</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">overlay traefik-net</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>et on va créer notre docker-compose contenant Traefik:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3.7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">traefik</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik:v2.5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> traefik</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">net</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;80:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;443:443&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;8080:8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./config:/etc/traefik&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">traefik-net</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">driver</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> overlay</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> traefik</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">net</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Puis, dans un dossier <strong>./config</strong>, nous allons créer le fichier <strong>traefik.yml</strong> qui va contenir notre configuration, et nos providers.</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># fichier traefik.yml, à mettre dans un dossier ./config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">level</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;INFO&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">format</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;common&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">providers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">endpoint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;unix:///var/run/docker.sock&quot;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Provider Docker sur la machine locale</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">exposedByDefault</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Par défaut, les conteneurs ne possèdent pas de redirection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">network</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik-net&quot;</span><span class="token plain">                    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Le réseau docker dans lequel il y aura.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">watch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">filename</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/etc/traefik/dynamic.yml&quot;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Fichier contenant les règles statiques</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">watch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain">                               </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Va actualiser son contenu régulièrement pour mettre les règles à jour</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">providersThrottleDuration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain">               </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Va actualiser les règles chaque 10s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">api</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                                          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Va rendre le Dashboard de Traefik accessible en http</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">dashboard</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">debug</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">insecure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">entryPoints</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                                  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Notre entrée, nous acceptons les requetes via https sur le port 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">insecure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:80&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Et notre fichier <strong>dynamic.yml</strong> qui contiendra nos règles statiques :</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">routers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">helloworld-http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">rule</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Host(`hello-world.tld`)&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">service</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">world</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">entryPoints</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> insecure </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hello-world</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">loadBalancer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">servers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://192.168.128.1:80&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>En démarrant Traefik, on on remarque qu&#x27;il va se mettre à jour chaque 10s en interrogeant le daemon Docker ainsi que le fichier.</p><p>On peut maintenant créer notre premier conteneur à rajouter de cette manière:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3.7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">whoami</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;containous/whoami&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;whoami&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;whoami&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.whoami.entrypoints=insecure&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.whoami.rule=Host(`whoami-tf.thebidouilleur.xyz`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.whoami.tls.certresolver=letsencrypt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> traefik_net</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Nous avons alors créé la règle &quot;whoami-tf.thebidouilleur.xyz&quot; vers notre conteneur. On remarque que <strong>nous n&#x27;avons pas exposé de port</strong>, Traefik va passer par le réseau interne <em>traefik_net</em> pour accéder au service.  C&#x27;est une couche de sécurité à ne pas négliger, vos services seront accessibles entre eux, et via le reverse-proxy.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gestion-des-certificats-https">Gestion des certificats https<a href="#gestion-des-certificats-https" class="hash-link" aria-label="Direct link to Gestion des certificats https" title="Direct link to Gestion des certificats https">​</a></h3><p>Maintenant, si vous passez par internet pour accéder à vos services.. C&#x27;est peut-être pratique d&#x27;avoir du https, et justement : Traefik gèrera vos certificats de manière automatique.
Traefik utilise l&#x27;api gratuite de <strong>LetsEncrypt</strong> pour obtenir ses certificats, nous devons donc créer une entrée dédiée au https sur le port 443</p><p>On va donc mettre à jour notre configuration comme ceci :</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">entryPoints</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">insecure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token key atrule">redirections</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token key atrule">entryPoint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         </span><span class="token key atrule">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> secure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">secure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:443&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">certificatesResolvers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">letsencrypt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">acme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">email</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;contact@thoughtless.eu&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/etc/traefik/acme.json&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      caServer: &quot;https://acme-staging-v02.api.letsencrypt.org/directory&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">keyType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;EC256&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">httpChallenge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">entryPoint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;insecure&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Redémarrez Traefik, et celui-ci tentera de générer les certificats pour les domaines configurés !
En accédant à la page suivante : <em><a href="http://traefik:8080" target="_blank" rel="noopener noreferrer">http://traefik:8080</a></em> ,vous aurez un dashboard sur lequel vous verrez les routeurs &quot;domaines d&#x27;entrés&quot;, les &quot;services&quot; (redirections), et si ce symbole apparait : Traefik a bien appliqué un certificat à ce router.</p><p>Il est également possible, avec un peu plus de configuration, d&#x27;obtenir un certificat <strong>Wildcard</strong> (<em>certificat valide pour un domaine entier</em>)  avec Traefik. Pour le moment : je n&#x27;ai pas besoin d&#x27;un wildcard pour mes domaines.
Si le sujet vous intéresse, voici un lien pour approfondir ça : <a href="https://computerz.solutions/traefik-ssl-wildcard-letsencrypt/" target="_blank" rel="noopener noreferrer">Certificat Wildcard Traefik</a></p><p>Et si on allait plus loin ?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="traefik-et-swarm">Traefik et Swarm<a href="#traefik-et-swarm" class="hash-link" aria-label="Direct link to Traefik et Swarm" title="Direct link to Traefik et Swarm">​</a></h3><p>Depuis maintenant un peu plus d&#x27;un an, mes conteneurs tournent sur un <strong>cluster swarm</strong> <em>(Si vous ne savez pas ce qu&#x27;est un Swarm, je vous renvoie vers <a href="https://thebidouilleur.xyz/posts/DockerSwarm/" target="_blank" rel="noopener noreferrer">cet article</a>)</em>, et ça peut complexifier les choses lorsque les labels (permettant à traefik de comprendre quel docker correspond à quel domaine) fonctionnent un peu différemment.</p><p>Les labels classiquent ne fonctionnent que sur la machine <em>hote</em> (par exemple: <em>Worker01</em>) mais si Traefik est sur la machine <em>Worker02</em>, les labels des conteneurs ne seront pas visibles.
Pour palier à ce problème, nous devons utiliser les mêmes labels … dans la section <strong>deploy</strong> d&#x27;un docker-compose.</p><p>Voici le docker-compose whoami adapté pour Swarm:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3.7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">whoami</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;containous/whoami&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;whoami&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;whoami&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.whoami.entrypoints=insecure&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.whoami.rule=Host(`whoami-tf.thebidouilleur.xyz`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.whoami.tls.certresolver=letsencrypt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">default</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> traefik_net</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-danger alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>à noter que cette structure ne fonctionne qu&#x27;avec les docker-compose de version &gt;3.7</p></div></div><p>Et pour que le conteneur traefik puisse lire ces labels.. Il doit être sûr <strong>un manager</strong> du swarm. Nous devons donc également mettre à jour notre docker-compose de Traefik :</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3.7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">traefik</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik:v2.5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> traefik</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">net</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;80:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;443:443&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;8080:8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./config:/etc/traefik&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">placement</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">constraints</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> node.role == manager</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.traefik.entrypoints=secure&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.traefik.rule=Host(`traefik.forky.ovh`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.traefik.tls.certresolver=letsencrypt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.services.traefik.loadbalancer.server.port=8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">traefik-net</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">driver</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> overlay</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> traefik</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">net</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>et nous pouvons le déployer dans le swarm avec la commande</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> stack deploy -c docker-compose.yml traefik</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Autre spécificité du Swarm : Si le port d&#x27;écoute du service n&#x27;est <strong>pas 80</strong>, il faudra préciser à Traefik le port à utiliser. C&#x27;est ce qu&#x27;on peut voir sur le docker-compose ci-dessus avec <code>traefik.http.services.traefik.loadbalancer.server.port</code>, ça sera la dernière différence entre Traefik sur une machine standalone et un cluster.</p><p>Maintenant, comment faire si nous voulons créer une règle automatique avec une machine qui n&#x27;est <strong>pas</strong> dans notre swarm ?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="astuce-pour-machines-isolées-du-cluster">Astuce pour machines isolées du cluster<a href="#astuce-pour-machines-isolées-du-cluster" class="hash-link" aria-label="Direct link to Astuce pour machines isolées du cluster" title="Direct link to Astuce pour machines isolées du cluster">​</a></h2><p>Jusque-là, nous avons <strong>2 providers</strong> : le provider <em>Docker (pour le cluster)</em> et le provider <em>file</em> qui concerne les règles statiques <em>(comme mon pfsense)</em>.
Traefik n&#x27;accepte pas qu&#x27;on ait <em>2 providers du même type</em>, ce qui veut dire que je ne peux pas surveiller le daemon docker de ma machine, ainsi que celui d&#x27;une machine distante.</p><p>Par exemple, mon <em>Gitea</em> est un conteneur qui n&#x27;est pas dans mon swarm, et comme c&#x27;est une machine que je redeploie régulièrement (et donc IP différente), j&#x27;aimerai beaucoup laisser traefik faire son travail, mais en le laissant en même temps s&#x27;occuper du swarm !</p><p>C&#x27;est là que j&#x27;ai découvert un projet Github répondant à ce besoin : <a href="https://github.com/jittering/traefik-kop" target="_blank" rel="noopener noreferrer">Traefik-pop</a></p><p>Le schéma ASCII du dépôt parle de lui-même :</p><div class="language-scheme codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scheme codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        +---------------------+          +---------------------+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        |                     |          |                     |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+---------+     :443    |  +---------+        |     :3000|  +------------+     |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|   WAN   |---------------&gt;| traefik |---------------------&gt;|    gitea   |     |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+---------+             |  +---------+        |          |  +------------+     |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        |       |             |          |                     |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        |  +---------+        |          |  +-------------+    |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        |  |  redis  |&lt;---------------------| traefik-kop |    |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        |  +---------+        |          |  +-------------+    |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        |             swarm   |          |             gitea   |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        +---------------------+          +---------------------+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>J&#x27;ai un peu modifié le dessin pour qu&#x27;il colle à mon exemple</em>.</p><p>Si le dessin est un peu compliqué : Nous allons créer une base de donnée <strong>Redis</strong> <em>(C&#x27;est plus facile pour moi de le mettre sur le swamr, mais théoriquement, vous pouvez la mettre où vous voulez)</em>. Cette bdd, sera utilisée en tant que <strong>provider Traefik</strong> pour mettre à jour les règles automatiquements !
Le docker-compose de mon gitea devient donc :</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">gitea</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gitea/gitea</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gitea</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> USER_UID=1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> USER_GID=1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GIT_DISCOVERY_ACROSS_FILESYSTEM=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> gitea</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./gitea</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> /etc/timezone</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/etc/timezone</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> /etc/localtime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/etc/localtime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3000:3000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2200:22&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.gitea.entrypoints=secure&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.gitea.rule=Host(`git.thoughtless.eu`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.routers.gitea.tls.certresolver=letsencrypt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;traefik.http.services.gitea.loadbalancer.server.port=3000&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>En redémarrant Traefik, et en accédant au panel, on remarque un nouvel provider : <em>Redis</em>.</p><p>et en visualisant les règles : nous avons bien notre règle concernant Gitea !</p><h1>Conclusion</h1><p>Traefik est un des meilleurs reverses-proxy pour les infrastructures grandissantes. Celui-ci s&#x27;adapte à de nombreux besoins en proposant une couche d&#x27;automatisation sans négliger la gestion statique et manuelle.
Celui-ci demande un temps d&#x27;adaptation qui sera vite rentabilisé.</p><p>J&#x27;espère que ce reverse-proxy vous inspirera pour une infrastructure scalable simple et fiable.</p><p>Merci de m&#x27;avoir lu !</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/traefik">traefik</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">docker</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/loki-grafana">Utilisation de Loki pour Centraliser les logs</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-12-12T00:00:00.000Z" itemprop="datePublished">December 12, 2021</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>[ Cet article provient de mon ancien-blog, celui-ci sera également disponible dans la partie &quot;Documentation&quot; du site ]</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>Depuis que jai commencé l&#x27;informatique (depuis un peu moins d&#x27;une dizaine d&#x27;année), je ne me suis jamais préoccupé de comment je visualisais mes logs. Un petit <em>view</em> par ci, un gros <em>grep</em> par là.. mais aucune gestion avancée.</p><p>J&#x27;ai basé ma supervision sur Zabbix et Grafana qui m&#x27;affichent les metriques de chaque machine virtuelle individuellement. Et même si c&#x27;est bien pratique, je n&#x27;ai presque aucun visuel sur l&#x27;état de mes applications !
J&#x27;ai donc décidé de me renseigner sur Graylog et Elastic Search proposant une stack assez fiable et facile à mettre en place. Puis en voyant les ressources demandées, j&#x27;ai remis ce besoin à &quot;plus tard&quot;, et j&#x27;ai remis &quot;plus tard&quot; à l&#x27;année prochaine.. Et ainsi de suite !</p><blockquote><blockquote><p>2 ans plus tard…</p></blockquote></blockquote><p>Aujourd&#x27;hui <em>(Decembre 2021)</em>, une grosse faille 0day est dévoilée concernant Log4J, et on ne parle pas d&#x27;une &quot;petite&quot; faille, c&#x27;est une bonne grosse RCE comme on les aime !</p><p>Je ne suis pas concerné par Log4J, ce n&#x27;est pas utilisé dans Jenkins, et je n&#x27;ai aucune autre application basée sur Java ouverte sur internet. Mais j&#x27;aurai bien aimé savoir si mon serveur a été scanné par les mêmes IP que l&#x27;on retrouve sur les listes à bannir.
Et c&#x27;est avec cet évenement que j&#x27;ai décidé de me renseigner sur <em>&quot;Comment centraliser et visualiser ses logs?&quot;</em>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="le-choix-de-la-stack">Le choix de la stack<a href="#le-choix-de-la-stack" class="hash-link" aria-label="Direct link to Le choix de la stack" title="Direct link to Le choix de la stack">​</a></h2><p>une stack est un groupement de logiciel permettant de répondre à une fonction.
Un exemple classique est celui de la stack &quot;G.I.T.&quot; <em>(et non pas comme l&#x27;outil de versioning!)</em> :</p><ul><li>Grafana</li><li>Influxdb</li><li>Telegraf</li></ul><p>C&#x27;est une stack qui permet de visualiser les mectriques de différentes machines, InfluxDB est la base de donnée stockant les informations, Telegraf est l&#x27;agent qui permet aux machines d&#x27;envoyer les métriques, et Grafana est le service web permettant de les visualiser.</p><p>Comme dit dans l&#x27;introduction, j&#x27;utilise Zabbix qui me permet de monitorer et collecter les metriques, et j&#x27;y ai couplé Grafana pour les afficher avec beaucoup de paramètrages.</p><p>Dans la centralisation de logs (et la visualisation), on parle souvent de la stack suivant:</p><p>*<strong>*ELK**</strong>:</p><ul><li>ElasticSearch</li><li>Logstash</li><li>Kibana</li></ul><p>Mais cette stack n&#x27;est pas à déployer dans n&#x27;importe quel environnement, il est efficace, mais très lourd.</p><p>Dans ma quête pour trouver une stack permettant la centralisation de logs, j&#x27;apprécierai utiliser des services que je dispose déjà.<br>
<!-- -->Et voici le miracle à la mode de 2021 ! La stack GLP : <strong>Grafana, Loki, Promtail</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stack-glp">Stack GLP<a href="#stack-glp" class="hash-link" aria-label="Direct link to Stack GLP" title="Direct link to Stack GLP">​</a></h2><p>Là où j&#x27;apprécie particulièrement cette stack, c&#x27;est qu&#x27;il est léger. Beaucoup
plus léger que ELK qui, même si très efficace, demande beaucoup.</p><p><img loading="lazy" src="https://i.imgur.com/oWOwWsJ.png" alt="Extrait doc ELK" class="img_ev3q"></p><p>De même que Graylog2 + Elastic Search (une très bonne alternative) qui demande presque un serveur baremetal low-cost à lui seul.
<img loading="lazy" src="https://i.imgur.com/FkAq6sO.png" alt="Extrait doc graylog" class="img_ev3q"></p><p>Alors que Grafana / Loki ne demanderont que 2Go pour fonctionner efficacement et sans contraintes. (Grand maximum, à mon échelle : j&#x27;utiliserai beaucoup moins que 2Go)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installer-notre-stack">Installer notre stack<a href="#installer-notre-stack" class="hash-link" aria-label="Direct link to Installer notre stack" title="Direct link to Installer notre stack">​</a></h2><p>Je pars du principe que tout le monde sait installer un Grafana, c&#x27;est souvent vers ce service que les gens commencent l&#x27;auto-hebergement <em>(en même temps, les graphiques de grafana sont super sexy !)</em>.</p><p>Mais si vous n&#x27;avez pas encore installé votre Grafana <em>(dans ce cas, quittez la salle et revenez plus tard)</em>, <a href="https://grafana.com/docs/grafana/latest/installation/" target="_blank" rel="noopener noreferrer">voici un lien qui vous permettra de le faire assez rapidement</a></p><p>Par simplicité, je ne vais pas utiliser Docker dans cette installation.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partie-loki">Partie Loki<a href="#partie-loki" class="hash-link" aria-label="Direct link to Partie Loki" title="Direct link to Partie Loki">​</a></h2><p>J&#x27;ai installé Loki sur un conteneur LXC en suivant le guide sur le site officiel <a href="https://grafana.com/docs/loki/latest/installation/local/" target="_blank" rel="noopener noreferrer">ici</a>.
Je passe par systemd pour lancer l&#x27;executable, et je créé à l&#x27;avance un fichier
avec le minimum syndical (qui est disponible sur le github de Grafana)</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">auth_enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">http_listen_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">grpc_listen_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">common</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">path_prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /tmp/loki</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">filesystem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">chunks_directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /tmp/loki/chunks</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">rules_directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /tmp/loki/rules</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">replication_factor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ring</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">instance_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kvstore</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">store</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inmemory</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">schema_config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">configs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">from</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-10-24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">store</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> boltdb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">shipper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">object_store</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> filesystem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v11</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> index_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 24h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Je n&#x27;ai pas pris la peine d&#x27;activer l&#x27;authentification en sachant que je suis dans un LAN avec uniquement mes machines virtuelles. Je considère pas que mon Loki comme un point sensible de mon infra.</p><p>Après seulement 2-3 minutes de configuration, notre Loki est déjà disponible !</p><p>On peut dès maintenant l&#x27;ajouter en tant que <em>datasource</em> sur notre Grafana :
<img loading="lazy" src="https://i.imgur.com/G3tWx1r.png" alt="Configuration de Loki sur Grafana" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contexte</div><div class="admonitionContent_S0QG"><ul><li>J&#x27;utilise localhost car la machine possédant le grafana héberge également le Loki.*</li><li>Il se peut que Grafana rale un peu car notre base de donnée Loki est vide.</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partie-promtail">Partie Promtail<a href="#partie-promtail" class="hash-link" aria-label="Direct link to Partie Promtail" title="Direct link to Partie Promtail">​</a></h2><p>Promtail est l&#x27;agent qui va nous permettre d&#x27;envoyer nos logs à Loki, j&#x27;ai écris un role Ansible assez simple me permettant d&#x27;installer notre agent sur de nombreuses machines en surveillant les logs provenant de Docker, varlog et syslog.</p><p>Voici ma template Jinja2 à propos de ma configuration :</p><div class="language-jinja2 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jinja2 codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  http_listen_port: 9080</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  grpc_listen_port: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">positions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  filename: /tmp/positions.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">clients:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if loki_url is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - url: {{ loki_url }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">scrape_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: authlog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: authlog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/log/auth.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: syslog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: syslog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/log/syslog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: Containers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: containerslogs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/lib/docker/containers/*/*-json.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: DaemonLog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: daemon</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/log/daemon.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>Si vous n&#x27;êtes pas à l&#x27;aise avec des templates Jinja2, vous trouverez une version &quot;pure&quot; de la config <a href="https://github.com/QJoly/promtail-ansible" target="_blank" rel="noopener noreferrer">ici</a></em></p><p>Vous pouvez bien evidemment adapter cette template à vos besoins. Mon idée première est d&#x27;avoir une &quot;base&quot; que je peux mettre sur chaque machine <em>(en sachant aussi que si aucun log n&#x27;est disponible, comme pour Docker, Promtail ne causera pas une erreur en ne trouvant pas les fichiers)</em></p><p>Une fois Promtail configuré, on peut le démarrer :
via l&#x27;executable directement :</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/opt/promtail/promtail -config.file /opt/promtail/promtail-local-config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ou via systemd <em>(automatique si vous passez par mon playbook)</em> :<br>
<code>systemctl start promtail</code></p><p>Une fois cet agent un peu partout, on va directement aller s&#x27;amuser sur Grafana !</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="faire-des-requetes-à-loki-depuis-grafana">Faire des requetes à Loki depuis Grafana<a href="#faire-des-requetes-à-loki-depuis-grafana" class="hash-link" aria-label="Direct link to Faire des requetes à Loki depuis Grafana" title="Direct link to Faire des requetes à Loki depuis Grafana">​</a></h2><p>On va faire quelque chose d&#x27;assez contre-intuitif : nous n&#x27;allons pas commencer par faire un Dashboard : on va d&#x27;abord tester nos requetes !
<em>Scrollez pas, je vous jure que c&#x27;est la partie la plus fun !</em></p><p>Sur Grafana, nous avons un onglet &quot;Explore&quot;. Celui-ci va nous donner accès à Loki en écrivant des requetes, celles-ci sont assez simple, et surtout en utilisant l&#x27;outil &quot;click-o-drome&quot; en dépliant le <em>Log Browser</em>
<img loading="lazy" src="https://i.imgur.com/UNL2s6m.png" alt="Metric browser" class="img_ev3q">
<em>Pardon j&#x27;ai un chouïa avancé sans vous...</em></p><p>Avec la template que je vous ai donné, vous aurez 4 jobs :</p><ul><li>daemon</li><li>authlog</li><li>syslog</li><li>containersjobs</li></ul><p>Ces jobs permettent de trier les logs, on va tester ça ensemble. Nous allons donc selectionner la machine <em>&quot;Ansible&quot;</em>, puis demander le job <em>&quot;authlog&quot;</em>.
Je commence par cliquer sur Ansible, puis Authlog. Grafana me proposera exactement si je souhaite choisir un fichier spécifique. Si on ne précise pas de fichier(<em>filename</em>) Grafana prendra tous les fichiers <em>(donc aucune importance si nous n&#x27;avons qu&#x27;un seul fichier)</em></p><p><em>vous remarquerez plus tard que dès notre 1ere selection, grafana va cacher les jobs/hôte/fichier qui ne concernent pas notre début de requete.</em></p><p><img loading="lazy" src="https://i.imgur.com/MWFQCyl.png" alt="Selections de paramètres" class="img_ev3q"></p><p>En validant notre requete (*bouton <strong>show logs*</strong>)</p><p><img loading="lazy" src="https://i.imgur.com/RCpb5GI.png" alt="Visualisation des logs de la machine &#x27;Ansible&#x27;" class="img_ev3q"></p><p>Nous avons donc le résultat de la requete vers Loki dans le lapse de temps configuré dans Grafana (1h pour moi).
Mon authlog n&#x27;est pas très interessant, et mon syslog est pollué par beaucoup
de message pas très pertinents.</p><p>Nous allons donc commencer à <strong>trier</strong> nos logs !</p><p>En cliquant sur le petit &quot;<strong><em>?</em></strong>&quot; au dessus de notre requete, nous avons une
&quot;cheatsheet&quot; résumant les fonctions basiques de Loki.
Nous découvrons comment faire une recherche exacte avec <em>|=</em>, comment ignorer
les lignes avec <em>!=</em> et comment utiliser une expression regulière avec <em>|~</em></p><p>Je vous partage également une cheatsheet un peu plus complète que j&#x27;ai trouvé
sur un blog : <a href="https://megamorf.gitlab.io/cheat-sheets/loki/" target="_blank" rel="noopener noreferrer">ici</a></p><p>Ainsi, on peut directement obtenir des logs un peu plus colorés qui nous permettrons de cibler l&#x27;essentiel !</p><p><img loading="lazy" src="https://i.imgur.com/HzTwmwW.png" alt="Log de la machine &#x27;Drone-Runner&#x27;" class="img_ev3q"></p><p>(L&#x27;idée est de cibler les logs sympas avec les couleurs qui vont avec)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>Si on entend souvent parler de la suite ELK, ça n&#x27;est pas non-plus une raison
pour s&#x27;en servir à tout prix ! Loki est une bonne alternative proposant des
fonctionnalitées basiques qui suffiront pour la plupart.</p><div class="theme-admonition theme-admonition-danger alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Ce projet est obsolète, il peut être risqué de s&#x27;en servir dans un environnement sensible.</p></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">Docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/logs">Logs</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/presentation-docker-swarm">Quick presentation of Docker Swarm</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-29T00:00:00.000Z" itemprop="datePublished">June 29, 2021</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>[ This article is from my old-blog, it will also be available in the &quot;Documentation&quot; section of the site ]</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>The world of containerization has brought many things into system administration, and has updated the concept of DevOps. But one of the main things that containers (and especially Docker) bring us is <strong>automation</strong>.</p><p>And although Docker is already complete with service deployment, we can go a little further by automating container management! And to answer that: <em>Docker Inc.</em> offers a tool suitable for automatic instance orchestration: <strong>Docker Swarm</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-docker-swarm">What is Docker Swarm?<a href="#what-is-docker-swarm" class="hash-link" aria-label="Direct link to What is Docker Swarm?" title="Direct link to What is Docker Swarm?">​</a></h2><p>As previously stated: Docker Swarm is an orchestration tool. With this tool, we can automatically manage our containers with rules favoring High-availability, and Scalability of your services.
We can therefore imagine two scenarios that are entirely compatible:</p><ul><li>Your site has a peak load and requires several containers: Docker Swarm manages replication and load balancing</li><li>A machine hosting your Dockers is down: Docker Swarm replicates your containers on other machines.</li></ul><p>So we&#x27;ll see how to configure that, and take a little look at the state of play of the features on offer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-swarm-cluster">Create Swarm Cluster<a href="#create-swarm-cluster" class="hash-link" aria-label="Direct link to Create Swarm Cluster" title="Direct link to Create Swarm Cluster">​</a></h2><p><em>For testing, I will use PWD (Play With Docker) to avoid mounting this on my infra</em>:)</p><p>So I have 4 machines under <strong>Alpine</strong> on which I will start a Swarm cluster.
<img loading="lazy" src="https://i.imgur.com/7mD3suS.png" alt="4 terminals, one per node" class="img_ev3q"></p><p>The first step is to define a Manager, this will be the head of the cluster, as well as the access points to the different machines.
In our case, we will make it very simple, the manager will be <strong>Node1</strong>.</p><p>To start the Swarm on the manager, simply use the &#x27;docker swarm init&#x27; command.
<strong>But</strong>, if your system has a network card count greater than 1 <em>(Fairly easy on a server)</em>, you must give the listening IP.
In my case, the LAN interface IP (where VMs communicate) is <em>192.168.0.8</em>.
So the command I&#x27;m going to run is</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> swarm init èèadvertise-addr </span><span class="token number" style="color:rgb(247, 140, 108)">192.168</span><span class="token plain">.0.8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Docker says:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Swarm initialized: current </span><span class="token function" style="color:rgb(130, 170, 255)">node</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cdbgbq3q4jp1e6espusj48qm3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> is now a manager.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">To </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> a worker to this swarm, run the following command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> swarm </span><span class="token function" style="color:rgb(130, 170, 255)">join</span><span class="token plain"> —token SWMTKN-1-5od5zuquln0kgkxpjybvcd45pctp4cp0l12srhdqe178ly8s2m-046hmuczuim8oddmk08gjd1fp </span><span class="token number" style="color:rgb(247, 140, 108)">192.168</span><span class="token plain">.0.8:2377</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">To </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> a manager to this swarm, run </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;docker swarm join-token manager&#x27;</span><span class="token plain"> and follow the instructions.`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In summary: The cluster is well started, and it gives us the exact command to join the cluster from other machines!
Since Node1 is the manager, I just need to run the docker swarm join command on Node2-4.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> swarm </span><span class="token function" style="color:rgb(130, 170, 255)">join</span><span class="token plain"> --token SWMTKN-1-5od5zuquln0kgkxpjybvcd45pctp4cp0l12srhdqe178ly8s2m-046hmuczuim8oddmk08gjd1fp </span><span class="token number" style="color:rgb(247, 140, 108)">192.168</span><span class="token plain">.0.8:2377</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once completed, you can view the result on the <em>manager</em> with the command &#x27;docker node ls&#x27;
<img loading="lazy" src="https://i.imgur.com/2rgU3wm.png" alt="All node in terminal" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-a-simple-service">Deploy a simple service<a href="#deploy-a-simple-service" class="hash-link" aria-label="Direct link to Deploy a simple service" title="Direct link to Deploy a simple service">​</a></h2><p>If you are a docker run user and you refuse docker-compose, you should know one thing: i don&#x27;t like you.
As you are nice to me, here is a piece of information that won&#x27;t help: the equivalent of &#x27;docker run&#x27; in Swarm is &#x27;docker service&#x27;. But we&#x27;re not going to get into that in this article.</p><p>Instead, we will use the docker-composed equivalent, which is the docker stack.
So first of all, here&#x27;s the .yml file</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">viz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dockersamples/visualizer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;8080:8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">placement</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">constraints</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> node.role == manager</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before you start it, you&#x27;ll probably notice the <strong>deploy</strong> part that lets you give directions to Swarm. So we can add constraints to deploy this on the manager(s), ask the host to limit the use of resources, or manage replicas for load balancing.</p><p>This first container will be used to have a simple dashboard to see where the Dashboards are positioned, and avoid going to CLI only for this function.</p><p>We will deploy this compose with the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> stack deploy —compose-file docker-compose.yml swarm-visualize</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once the command is complete, you simply open the manager&#x27;s web server at port 8080.
<img loading="lazy" src="https://i.imgur.com/sVKKmtj.png" alt="WEBUI Swarm" class="img_ev3q"></p><p>So we now have a web panel to track container updates.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="simplified-management-of-replicas">Simplified management of replicas<a href="#simplified-management-of-replicas" class="hash-link" aria-label="Direct link to Simplified management of replicas" title="Direct link to Simplified management of replicas">​</a></h2><p>When you access a container, you must go through the manager. But there is nothing to prevent being redirected to the 3-4 node via the manager. This is why it is possible to distribute the load balancing with a system similar to HAProxy, i.e. by redirecting users to a different container each time a page is loaded.</p><p>Here is a docker-compose automatically creating replicas:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;3.3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hello-world</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;80:8000&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> crccheck/hello</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">world</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And the result is surprising:
<img loading="lazy" src="https://i.imgur.com/27a7V2i.png" alt="Scaling hello-world with 4" class="img_ev3q"></p><p>We can also adjust the number of replica.
By decreasing it:</p><p><code>docker service scale hello-world_hello-world=2</code></p><p><img loading="lazy" src="https://i.imgur.com/pf4Y1ih.png" alt="Scaling hello-world with 2" class="img_ev3q"></p><p>Or by increasing it:</p><p><code>docker service scale hello-world_hello-world=20</code></p><p><img loading="lazy" src="https://i.imgur.com/MW5uUOq.png" alt="Scaling hello-world with 20" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-about-high-availability">What about High Availability?<a href="#what-about-high-availability" class="hash-link" aria-label="Direct link to What about High Availability?" title="Direct link to What about High Availability?">​</a></h2><p>I focused this article on the functions of Swarm, and how to use them. And if I did not address this item first, it is because every container created in this post is managed in HA!
For example, I will forcibly stop the 10th replica of the &quot;Hello world&quot; container, which is on <strong>Node1</strong>. And this one will be directly revived,
<img loading="lazy" src="https://i.imgur.com/7Ni9NNG.png" alt="Kill hello-world" class="img_ev3q"></p><blockquote><p>Okay, But docker could already automatically restart containers in case of problem, how is swarm different?</p></blockquote><p>And to answer that, I&#x27;m going to stop the <strong>node4</strong>
<img loading="lazy" src="https://i.imgur.com/ejkzT7a.png" alt="Kill Node4" class="img_ev3q"></p><p>It is noted that the other nodes distribute automatically (and without any intervention) the stopped containers. And since we only access services through managers, they will only redirect to the containers that are started.
One of the servers can therefore catch fire, the service will always be redundant, balanced, and accessible.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>Docker-Swarm is a gateway to application clusters that are incredibly complex without a suitable tool. Swarm is easy to meet special needs without any technical expertise.
In a production environment, it is advisable to switch to Kubernetes or Nomad which are much more complete and powerful alternatives.</p><p>I encourage you to try this kind of technology that will govern our world of tomorrow!</p><p>Thanks for reading</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/swarm">swarm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/containers">containers</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/cluster">cluster</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Me Suivre</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/TheBidouilleur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://thebidouilleur.xyz/blog/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Flux RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ko-fi.com/thebidouilleur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Me soutenir<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/blog/archive">Historique</a></li><li class="footer__item"><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="footer__link-item">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 TheBidouilleur.</div></div></div></footer></div>
<script src="/TheBidouilleur.xyz/en/assets/js/runtime~main.3337d4b0.js"></script>
<script src="/TheBidouilleur.xyz/en/assets/js/main.c6b24396.js"></script>
</body>
</html>