<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">3 posts tagged with &quot;docker&quot; | TheBidouilleur</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/img/BMO.png"><meta data-rh="true" name="twitter:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/img/BMO.png"><meta data-rh="true" property="og:url" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/tags/docker"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" property="og:title" content="3 posts tagged with &quot;docker&quot; | TheBidouilleur"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/TheBidouilleur.xyz/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/tags/docker"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/blog/tags/docker" hreflang="en"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/tags/docker" hreflang="fr"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/blog/tags/docker" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TheBidouilleur.xyz/en/blog/rss.xml" title="TheBidouilleur RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TheBidouilleur.xyz/en/blog/atom.xml" title="TheBidouilleur Atom Feed">



<script src="https://stats.192168128.xyz/js/script.js" defer="defer" data-domain="thebidouilleur.xyz"></script><link rel="stylesheet" href="/TheBidouilleur.xyz/en/assets/css/styles.3c5ca030.css">
<link rel="preload" href="/TheBidouilleur.xyz/en/assets/js/runtime~main.ae63514e.js" as="script">
<link rel="preload" href="/TheBidouilleur.xyz/en/assets/js/main.8d00268d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TheBidouilleur.xyz/en/"><div class="navbar__logo"><img src="/TheBidouilleur.xyz/en/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--light_HNdA"><img src="/TheBidouilleur.xyz/en/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TheBidouilleur</b></a><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TheBidouilleur.xyz/en/blog">Blog</a><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/TheBidouilleur.xyz/en/blog/tags/docker" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/TheBidouilleur.xyz/blog/tags/docker" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Français</a></li></ul></div><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/en/blog/archive">Archives</a><a href="https://twitter.com/thebidouilleur" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/Creer-son-registre-helm">Créer son propre registre helm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/kubernetes-hcl">Kubernetes in HCL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/cluster-maj">Keep your clusters up-to-date</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/remarkable">Remarkable, a step forward in note taking</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/nixos">NixOS, Ma nouvelle distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/gyroroue">Mes débuts à la gyroroue</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/longhorn">Longhorn, stockage distribué</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/s3contabo">Mes débuts avec s3</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/presentation-packer">Quick Presentation of Packer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/loki-grafana">Utilisation de Loki pour Centraliser les logs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/caddy">Too many loadbalancers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TheBidouilleur.xyz/en/blog/presentation-docker-swarm">Quick presentation of Docker Swarm</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;docker&quot;</h1><a href="/TheBidouilleur.xyz/en/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/cluster-maj">Keep your clusters up-to-date</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-11-10T00:00:00.000Z" itemprop="datePublished">November 10, 2022</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjoly/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Since the DevOps movement started (or rather <em>Platform engineering</em>), the topic of high availability has been brought to the forefront. And one of the most versatile solutions to achieve high availability is to create application clusters. (and so: containers)</p><p>So I&#x27;ve been running a Swarm cluster for a few years and I recently switched to Kubernetes <em>(k3s to be precise)</em>. And by having clusters holding several hundreds of containers, we forget about maintenance and update.</p><p>And in this article, we will talk about updates.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="out-of-cluster-container-upgrade-solutions">Out-of-cluster container upgrade solutions<a class="hash-link" href="#out-of-cluster-container-upgrade-solutions" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="watchtower">WatchTower<a class="hash-link" href="#watchtower" title="Direct link to heading">​</a></h3><p>I think the best known solution is <a href="https://containrrr.dev/watchtower/" target="_blank" rel="noopener noreferrer">Watchtower</a></p><p>Watchtower is easy to use and is based (like many others) on <strong>labels</strong>. A label allows to define some parameters and to activate (or deactivate) the monitoring of updates.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Updating is not always good...</div><div class="admonitionContent_S0QG"><p>Be careful not to automatically update sensitive programs! We can&#x27;t check what an update and if they won&#x27;t break something.
It&#x27;s up to you to choose which applications to monitor, and to trigger an update or not.</p></div></div><p>WatchTower will notify you in several ways:</p><ul><li>email</li><li>slack</li><li>msteams</li><li>gotify</li><li>shoutrrr</li></ul><p>And among these methods, you do not have only proprietary solutions, free to you to host a shoutrrr, a gotify or to use your smtp so that this information does not leave your IS! *(I am very critical of the use of msteams, slack, discord to receive notifications)</p><p>WatchTower will scan for updates on a regular basis <em>(configurable)</em>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="container-updater-from-papamica">container-updater (from <a href="https://github.com/PAPAMICA" target="_blank" rel="noopener noreferrer">@PAPAMICA</a>)<a class="hash-link" href="#container-updater-from-papamica" title="Direct link to heading">​</a></h3><p>The most provided/complex solution is not always the best. Papamica has set up a bash script to meet his specific needs <em>(which many other people must have)</em>: an update system notifying him through Discord and Zabbix.</p><p>This one is also based on labels and also takes care of the case where you want to update by docker-compose. (<em>instead of doing a docker pull, docker restart like Watchtower</em>)</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;autoupdate=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;autoupdate.docker-compose=/link/to/docker-compose.yml&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Even if I don&#x27;t use it, I had a time when I was using Zabbix and I needed to be notified on my Zabbix. <em>(which notified me by Mail/Gotify)</em></p><p>Papamica states that he plans to add private registry support <em>(for now only github registry or dockerhub)</em> as well as other notification methods.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solutions-for-swarm">Solutions for Swarm<a class="hash-link" href="#solutions-for-swarm" title="Direct link to heading">​</a></h2><p>Swarm is probably the container orchestrator I enjoyed the most: it&#x27;s *<strong>*simple**</strong>! You learn fast, you discover fast and you get quick results.
But I&#x27;ve already written about Swarm in <a href="/TheBidouilleur.xyz/en/blog/presentation-docker-swarm/">another article</a>...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sheperd">Sheperd<a class="hash-link" href="#sheperd" title="Direct link to heading">​</a></h3><p>What I like in Papamica&#x27;s program (and that goes with Sheperd) is that we keep bash as the central language. A language that we all know in the main thanks to Linux, and that we can read and modify if we take the time.</p><p>Shepherd&#x27;s code is only <a href="https://github.com/djmaze/shepherd/blob/master/shepherd" target="_blank" rel="noopener noreferrer">~200 lines</a> and works fine like that.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shepherd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mazzolino/shepherd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/run/docker.sock</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/var/run/docker.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">placement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">constraints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> node.role == manager</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This one will accept several private registers, which gives a nice advantage compared to the other solutions presented.
Example:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> shepherd.enable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> shepherd.auth.config=blog</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Shepherd does not include a <em>(default)</em> notification system. That&#x27;s why its creator decided to offer a <a href="https://github.com/djmaze/shepherd/blob/master/docker-compose.apprise.yml" target="_blank" rel="noopener noreferrer">Apprise sidecar as an alternative</a>. Which can redirect to many things like Telegram, SMS, Gotify, Mail, Slack, msteams etc....</p><p>I think this is the simplest and most versatile solution. I hope it will be found in other contexts. I hope it will be found in other contexts <em>(but I don&#x27;t go into too much detail on the subject, I&#x27;d like to write an article about it)</em>.</p><p>I used Shepherd for a long time and I had no problems.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solutions-for-kubernetes">Solutions for Kubernetes<a class="hash-link" href="#solutions-for-kubernetes" title="Direct link to heading">​</a></h2><p>For Kubernetes, we start to lose in simplicity. Especially since with the <code>imagePullPolicy: Always</code> option, you just have to restart a pod to get the last image with the same <em>tag</em>.
For a long time, I used ArgoCD to update my configurations and re-deploy my images at each update on Git.</p><p>But ArgoCD is only used to <strong>update the configuration</strong> and not the image. The methodology is incorrect and it is necessary to find a suitable tool for that.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keelsh">Keel.sh<a class="hash-link" href="#keelsh" title="Direct link to heading">​</a></h3><p>Keel is a tool that meets the same need: Update pod images. But it incorporates several features not found elsewhere.</p><p><img loading="lazy" src="https://keel.sh/img/keel_high_level.png" alt="Keel" class="img_ev3q"></p><p>If you want to keep the same operation as the alternatives <em>(i.e. regularly check for updates)</em>, it is possible:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">keel.sh/policy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">keel.sh/trigger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> poll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">keel.sh/pollSchedule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@every 3m&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But where Keel excels is that it offers <strong>triggers</strong> and <strong>approvals</strong>.</p><p>A trigger is an event that will trigger the update of Keel. We can imagine a webhook coming from Github, Dockerhub, Gitea which will trigger the update of the server. *(So we avoid a regular crontab and we save resources, traffic and time)
As the use of webhook has become widespread in CICD systems, it can be coupled to many use cases.</p><p>The approvals are the little gem that was missing from the other tools. Indeed, I specified that <em>updating images is dangerous and you should not target sensitive applications in automatic updates</em>. And it&#x27;s just in response to that that Keel developed the <em>approvals</em>.</p><p><img loading="lazy" src="https://keel.sh/img/docs/approvals.png" class="img_ev3q"></p><p>The idea is to give permission to Keel to update the pod. We can choose the moment and check manually.</p><p>I think it&#x27;s a pity that we have Slack or MSTeams imposed for the approvals, it&#x27;s then a feature that I won&#x27;t use.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>A UI</div><div class="admonitionContent_S0QG"><p>So for now, I use Keel without its web interface, it may bring new features, but I would like to avoid an umpteenth interface to manage.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>Updating a container is not that easy when you are looking for automation and security. If today, I find that Keel corresponds to my needs, I have the impression that the tools are similar without offering real innovations. <em>(I&#x27;m thinking of tackling the canary idea one day)</em>
I hope to discover new solutions soon, hoping that they will better fit my needs.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/swarm">swarm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/kubernetes">kubernetes</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/loki-grafana">Utilisation de Loki pour Centraliser les logs</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-12-12T00:00:00.000Z" itemprop="datePublished">December 12, 2021</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://git.thoughtless.eu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://git.thoughtless.eu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>[ Cet article provient de mon ancien-blog, celui-ci sera également disponible dans la partie “Documentation” du site ]</p><h1>Introduction</h1><p>Depuis que jai commencé l’informatique (depuis un peu moins d’une dizaine d’année), je ne me suis jamais préoccupé de comment je visualisais mes logs. Un petit <em>view</em> par ci, un gros <em>grep</em> par là.. mais aucune gestion avancée. </p><p>J’ai basé ma supervision sur Zabbix et Grafana qui m’affichent les metriques de chaque machine virtuelle individuellement. Et même si c’est bien pratique, je n’ai presque aucun visuel sur l’état de mes applications !
J’ai donc décidé de me renseigner sur Graylog et Elastic Search proposant un stack assez fiable et facile à mettre en place. Puis en voyant les ressources demandées, j’ai remis ce besoin à “plus tard”, et j’ai remis “plus tard” à l’année prochaine.. Et ainsi de suite ! </p><blockquote><blockquote><p>2 ans plus tard…</p></blockquote></blockquote><p>Aujourd’hui <em>(Decembre 2021)</em>, une grosse faille 0day est dévoilée concernant Log4J, et on ne parle pas d’une “petite” faille, c’est une bonne grosse RCE comme on les aime ! </p><p>Je ne suis pas concerné par Log4J, ce n’est pas utilisé dans Jenkins, et je n’ai aucune autre application basée sur Java ouverte sur internet. Mais j’aurai bien aimé savoir si mon serveur a été scanné par les mêmes IP que l’on retrouve sur les listes à bannir.
Et c’est avec cet évenement que j’ai décidé de me renseigner sur <em>“Comment centraliser et visualiser ses logs?”</em>.</p><h1>Le choix du stack</h1><p>Un stack est un groupement de logiciel permettant de répondre à une fonction.
Un exemple classique est celui du stack “G.I.T.” <em>(et non pas comme l’outil de versioning!)</em> :</p><ul><li>Grafana</li><li>Influxdb</li><li>Telegraf </li></ul><p>C’est un stack qui permet de visualiser les mectriques de différentes machines, InfluxDB est la base de donnée stockant les informations, Telegraf est l’agent qui permet aux machines d’envoyer les métriques, et Grafana est le service web permettant de les visualiser.</p><p>Comme dit dans l’introduction, j’utilise Zabbix qui me permet de monitorer et collecter les metriques, et j’y ai couplé Grafana pour les afficher avec beaucoup de paramètrages. </p><p>Dans la centralisation de logs (et la visualisation), on parle souvent du stack suivant:</p><p><strong><strong>ELK</strong></strong>:</p><ul><li>ElasticSearch</li><li>Logstash</li><li>Kibana</li></ul><p>Mais ce stack n’est pas à déployer dans n’importe quel environnement, il est efficace, mais très lourd. </p><p>Dans ma quête pour trouver un stack permettant la centralisation de logs, j’apprécierai utiliser des services que je dispose déjà.<br>
<!-- -->Et voici le miracle à la mode de 2021 ! Le Stack GLP : <strong>Grafana, Loki, Promtail</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stack-glp">Stack GLP<a class="hash-link" href="#stack-glp" title="Direct link to heading">​</a></h2><p>Là où j’apprécie particulièrement ce stack, c’est qu’il est léger. Beaucoup
plus léger que ELK qui, même si très efficace, demande beaucoup.</p><p><img loading="lazy" src="https://i.imgur.com/oWOwWsJ.png" class="img_ev3q"></p><p>De même que Graylog2 + Elastic Search (une très bonne alternative) qui demande presque un serveur baremetal low-cost à lui seul.
<img loading="lazy" src="https://i.imgur.com/FkAq6sO.png" class="img_ev3q"></p><p>Alors que Grafana / Loki ne demanderont que 2Go pour fonctionner efficacement et sans contraintes. (Grand maximum, à mon échelle : j’utiliserai beaucoup moins que 2Go)</p><h1>Installer notre stack</h1><p>Je pars du principe que tout le monde sait installer un Grafana, c’est souvent vers ce service que les gens commencent l’auto-hebergement <em>(en même temps, les graphiques de grafana sont super sexy !)</em>. </p><p>Mais si vous n’avez pas encore installé votre Grafana <em>(dans ce cas, quittez la salle et revenez plus tard)</em>, <a href="https://grafana.com/docs/grafana/latest/installation/" target="_blank" rel="noopener noreferrer">voici un lien qui vous permettra de le faire assez rapidement</a></p><p>Par simplicité, je ne vais pas utiliser Docker dans cette installation. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partie-loki">Partie Loki<a class="hash-link" href="#partie-loki" title="Direct link to heading">​</a></h2><p>J’ai installé Loki sur un conteneur LXC en suivant le guide sur le site officiel <a href="https://grafana.com/docs/loki/latest/installation/local/" target="_blank" rel="noopener noreferrer">ici</a>.
Je passe par systemd pour lancer l’executable, et je créé à l’avance un fichier
avec le minimum syndical (qui est disponible sur le github de Grafana)</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http_listen_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">grpc_listen_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">common</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path_prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">filesystem</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chunks_directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/loki/chunks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">rules_directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/loki/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replication_factor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instance_addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kvstore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inmemory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">schema_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token datetime number" style="color:#36acaa">2020-10-24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> boltdb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shipper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">object_store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">schema</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">index</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> index_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">period</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 24h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Je n’ai pas pris la peine d’activer l’authentification en sachant que je suis dans un LAN avec uniquement mes machines virtuelles. Je considère pas que mon Loki comme un point sensible de mon infra. </p><p>Après seulement 2-3 minutes de configuration, notre Loki est déjà disponible ! </p><p>On peut dès maintenant l’ajouter en tant que <em>datasource</em> sur notre Grafana :
<img loading="lazy" src="https://i.imgur.com/G3tWx1r.png" class="img_ev3q"></p><p><em>(J’utilise localhost car la machine possédant le grafana héberge également le Loki)</em></p><p><em>Il se peut que Grafana rale un peu car notre base de donnée Loki est vide.</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partie-promtail">Partie Promtail<a class="hash-link" href="#partie-promtail" title="Direct link to heading">​</a></h2><p>Promtail est l’agent qui va nous permettre d’envoyer nos logs à Loki, j’ai écris un role Ansible assez simple me permettant d’installer notre agent sur de nombreuses machines en surveillant les logs provenant de Docker, varlog et syslog. </p><p>Voici ma template Jinja2 à propos de ma configuration : </p><div class="language-jinja2 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jinja2 codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http_listen_port: 9080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grpc_listen_port: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">positions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename: /tmp/positions.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clients:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if loki_url is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - url: {{ loki_url }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scrape_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: authlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: authlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/log/auth.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: syslog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: syslog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/log/syslog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: Containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: containerslogs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/lib/docker/containers/*/*-json.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- job_name: DaemonLog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      job: daemon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      __path__: /var/log/daemon.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>Si vous n’êtes pas à l’aise avec des templates Jinja2, vous trouverez une version “pure” de la config <a href="https://git.thoughtless.eu/Cinabre/rolePromtailAgent/src/branch/master/README.md" target="_blank" rel="noopener noreferrer">ici</a></em></p><p>Vous pouvez bien evidemment adapter cette template à vos besoins. Mon idée première est d’avoir une “base” que je peux mettre sur chaque machine <em>(en sachant aussi que si aucun log n’est disponible, comme pour Docker, Promtail ne causera pas une erreur en ne trouvant pas les fichiers)</em> </p><p>Une fois Promtail configuré, on peut le démarrer :
via l’executable directement : </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/opt/promtail/promtail -config.file /opt/promtail/promtail-local-config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ou via systemd <em>(automatique si vous passez par mon playbook)</em> :<br>
<code>systemctl start promtail</code> </p><p>Une fois cet agent un peu partout, on va directement aller s’amuser sur Grafana !</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="faire-des-requetes-à-loki-depuis-grafana">Faire des requetes à Loki depuis Grafana<a class="hash-link" href="#faire-des-requetes-à-loki-depuis-grafana" title="Direct link to heading">​</a></h2><p>On va faire quelque chose d’assez contre-intuitif : nous n’allons pas commencer par faire un Dashboard : on va d’abord tester nos requetes !
<em>Scrollez pas, je vous jure que c’est la partie la plus fun !</em></p><p>Sur Grafana, nous avons un onglet “Explore”. Celui-ci va nous donner accès à Loki en écrivant des requetes, celles-ci sont assez simple, et surtout en utilisant l’outil “click-o-drome” en dépliant le <em>Log Browser</em>
<img loading="lazy" src="https://i.imgur.com/UNL2s6m.png" class="img_ev3q"></p><center> <i> Pardon j&#x27;ai un chouïa avancé sans vous... </i> </center><p>Avec la template que je vous ai donné, vous aurez 4 jobs : </p><ul><li>daemon</li><li>authlog</li><li>syslog</li><li>containersjobs</li></ul><p>Ces jobs permettent de trier les logs, on va tester ça ensemble. Nous allons donc selectionner la machine <em>“Ansible”</em>, puis demander le job <em>“authlog”</em>.
Je commence par cliquer sur Ansible, puis Authlog. Grafana me proposera exactement si je souhaite choisir un fichier spécifique. Si on ne précise pas de fichier(<em>filename</em>) Grafana prendra tous les fichiers <em>(donc aucune importance si nous n’avons qu’un seul fichier)</em> </p><p><em>(vous remarquerez plus tard que dès notre 1ere selection, grafana va cacher les jobs/hôte/fichier qui ne concernent pas notre début de requete)</em> </p><p><img loading="lazy" src="https://i.imgur.com/MWFQCyl.png" class="img_ev3q"></p><p>En validant notre requete (<em>bouton <strong>show logs</strong></em>)</p><p><img loading="lazy" src="https://i.imgur.com/RCpb5GI.png" class="img_ev3q"></p><p>Nous avons donc le résultat de la requete vers Loki dans le lapse de temps configuré dans Grafana (1h pour moi).
Mon authlog n’est pas très interessant, et mon syslog est pollué par beaucoup
de message pas très pertinents. </p><p>Nous allons donc commencer à <strong>trier</strong> nos logs !</p><p>En cliquant sur le petit ”<strong><em>?</em></strong>” au dessus de notre requete, nous avons une
“cheatsheet” résumant les fonctions basiques de Loki.
Nous découvrons comment faire une recherche exacte avec <em>|=</em>, comment ignorer
les lignes avec <em>!=</em> et comment utiliser une expression regulière avec <em>|~</em></p><p>Je vous partage également une cheatsheet un peu plus complète que j’ai trouvé
sur un blog : <a href="https://megamorf.gitlab.io/cheat-sheets/loki/" target="_blank" rel="noopener noreferrer">ici</a> </p><p>Ainsi, on peut directement obtenir des logs un peu plus colorés qui nous permettrons de cibler l’essentiel ! </p><p><img loading="lazy" src="https://i.imgur.com/HzTwmwW.png" class="img_ev3q"></p><p>(L’idée est de cibler les logs sympas avec les couleurs qui vont avec) </p><h1>Conclusion</h1><p>Si on entend souvent parler de la suite ELK, ça n’est pas non-plus une raison
pour s’en servir à tout prix ! Loki est une bonne alternative proposant des
fonctionnalitées basiques qui suffiront pour la plupart.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">Docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/logs">Logs</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TheBidouilleur.xyz/en/blog/presentation-docker-swarm">Quick presentation of Docker Swarm</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-29T00:00:00.000Z" itemprop="datePublished">June 29, 2021</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://git.thoughtless.eu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/82603435?v=4" alt="TheBidouilleur"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://git.thoughtless.eu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TheBidouilleur</span></a></div><small class="avatar__subtitle" itemprop="description">Adorateur de trucs merdiques</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>[ This article is from my old-blog, it will also be available in the &quot;Documentation&quot; section of the site ]</p><h1>Docker Swarm</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>The world of containerization has brought many things into system administration, and has updated the concept of DevOps. But one of the main things that containers (and especially Docker) bring us is <strong>automation</strong>.</p><p>And although Docker is already complete with service deployment, we can go a little further by automating container management! And to answer that: <em>Docker Inc.</em> offers a tool suitable for automatic instance orchestration: <strong>Docker Swarm</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-docker-swarm">What is Docker Swarm?<a class="hash-link" href="#what-is-docker-swarm" title="Direct link to heading">​</a></h2><p>As previously stated: Docker Swarm is an orchestration tool. With this tool, we can automatically manage our containers with rules favoring High-availability, and Scalability of your services.
We can therefore imagine two scenarios that are entirely compatible:</p><ul><li>Your site has a peak load and requires several containers: Docker Swarm manages replication and load balancing</li><li>A machine hosting your Dockers is down: Docker Swarm replicates your containers on other machines.</li></ul><p>So we&#x27;ll see how to configure that, and take a little look at the state of play of the features on offer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-swarm-cluster">Create Swarm Cluster<a class="hash-link" href="#create-swarm-cluster" title="Direct link to heading">​</a></h2><p><em>For testing, I will use PWD (Play With Docker) to avoid mounting this on my infra</em>:)</p><p>So I have 4 machines under <strong>Alpine</strong> on which I will start a Swarm cluster.
<img loading="lazy" src="https://i.imgur.com/7mD3suS.png" class="img_ev3q"></p><p>The first step is to define a Manager, this will be the head of the cluster, as well as the access points to the different machines.
In our case, we will make it very simple, the manager will be <strong>Node1</strong>.</p><p>To start the Swarm on the manager, simply use the &#x27;docker swarm init&#x27; command.
<strong>But</strong>, if your system has a network card count greater than 1 <em>(Fairly easy on a server)</em>, you must give the listening IP.
In my case, the LAN interface IP (where VMs communicate) is <em>192.168.0.8</em>.
So the command I&#x27;m going to run is</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> swarm init èèadvertise-addr </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.0.8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Docker says:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Swarm initialized: current node (cdbgbq3q4jp1e6espusj48qm3) is now a manager.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To add a worker to this swarm, run the following command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker swarm join —token SWMTKN-1-5od5zuquln0kgkxpjybvcd45pctp4cp0l12srhdqe178ly8s2m-046hmuczuim8oddmk08gjd1fp 192.168.0.8:2377</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In summary: The cluster is well started, and it gives us the exact command to join the cluster from other machines!
Since Node1 is the manager, I just need to run the docker swarm join command on Node2-4.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> swarm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> --token SWMTKN-1-5od5zuquln0kgkxpjybvcd45pctp4cp0l12srhdqe178ly8s2m-046hmuczuim8oddmk08gjd1fp </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.0.8:2377</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once completed, you can view the result on the <em>manager</em> with the command &#x27;docker node ls&#x27;
<img loading="lazy" src="https://i.imgur.com/2rgU3wm.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-a-simple-service">Deploy a simple service<a class="hash-link" href="#deploy-a-simple-service" title="Direct link to heading">​</a></h2><p>If you are a docker run user and you refuse docker-compose, you should know one thing: i don&#x27;t like you.
As you are nice to me, here is a piece of information that won&#x27;t help: the equivalent of &#x27;docker run&#x27; in Swarm is &#x27;docker service&#x27;. But we&#x27;re not going to get into that in this article.</p><p>Instead, we will use the docker-composed equivalent, which is the docker stack.
So first of all, here&#x27;s the .yml file</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">viz</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dockersamples/visualizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8080:8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">placement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">constraints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> node.role == manager</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before you start it, you&#x27;ll probably notice the <strong>deploy</strong> part that lets you give directions to Swarm. So we can add constraints to deploy this on the manager(s), ask the host to limit the use of resources, or manage replicas for load balancing.</p><p>This first container will be used to have a simple dashboard to see where the Dashboards are positioned, and avoid going to CLI only for this function.</p><p>We will deploy this compose with the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> stack deploy —compose-file docker-compose.yml swarm-visualize</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once the command is complete, you simply open the manager&#x27;s web server at port 8080.
<img loading="lazy" src="https://i.imgur.com/sVKKmtj.png" class="img_ev3q"></p><p>So we now have a web panel to track container updates.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="simplified-management-of-replicas">Simplified management of replicas<a class="hash-link" href="#simplified-management-of-replicas" title="Direct link to heading">​</a></h2><p>When you access a container, you must go through the manager. But there is nothing to prevent being redirected to the 3-4 node via the manager. This is why it is possible to distribute the load balancing with a system similar to HAProxy, i.e. by redirecting users to a different container each time a page is loaded.</p><p>Here is a docker-compose automatically creating replicas:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;3.3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hello-world</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;80:8000&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> crccheck/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">world</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And the result is surprising:
<img loading="lazy" src="https://i.imgur.com/27a7V2i.png" class="img_ev3q"></p><p>We can also adjust the number of replica.
By decreasing it:</p><p><code>docker service scale hello-world_hello-world=2</code></p><p><img loading="lazy" src="https://i.imgur.com/pf4Y1ih.png" class="img_ev3q"></p><p>Or by increasing it:</p><p><code>docker service scale hello-world_hello-world=20</code></p><p><img loading="lazy" src="https://i.imgur.com/MW5uUOq.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-about-high-availability">What about High Availability?<a class="hash-link" href="#what-about-high-availability" title="Direct link to heading">​</a></h2><p>I focused this article on the functions of Swarm, and how to use them. And if I did not address this item first, it is because every container created in this post is managed in HA!
For example, I will forcibly stop the 10th replica of the &quot;Hello world&quot; container, which is on <strong>Node1</strong>. And this one will be directly revived,
<img loading="lazy" src="https://i.imgur.com/7Ni9NNG.png" class="img_ev3q"></p><blockquote><p>Okay, But docker could already automatically restart containers in case of problem, how is swarm different?</p></blockquote><p>And to answer that, I&#x27;m going to stop the <strong>node4</strong>
<img loading="lazy" src="https://i.imgur.com/ejkzT7a.png" class="img_ev3q"></p><p>It is noted that the other nodes distribute automatically (and without any intervention) the stopped containers. And since we only access services through managers, they will only redirect to the containers that are started.
One of the servers can therefore catch fire, the service will always be redundant, balanced, and accessible.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>Docker-Swarm is a gateway to application clusters that are incredibly complex without a suitable tool. Swarm is easy to meet special needs without any technical expertise.
In a production environment, it is advisable to switch to Kubernetes or Nomad which are much more complete and powerful alternatives.</p><p>I encourage you to try this kind of technology that will govern our world of tomorrow!</p><p>Thanks for reading</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/swarm">swarm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/containers">containers</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/blog/tags/cluster">cluster</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/TheBidouilleur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/blog/archive">Archives</a></li><li class="footer__item"><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="footer__link-item">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 TheBidouilleur.</div></div></div></footer></div>
<script src="/TheBidouilleur.xyz/en/assets/js/runtime~main.ae63514e.js"></script>
<script src="/TheBidouilleur.xyz/en/assets/js/main.8d00268d.js"></script>
</body>
</html>