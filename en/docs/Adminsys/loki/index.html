<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Adminsys/Loki">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Loki - Monitor logs | TheBidouilleur</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/img/BMO.png"><meta data-rh="true" name="twitter:image" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/img/BMO.png"><meta data-rh="true" property="og:url" content="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/docs/Adminsys/loki"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" name="keywords" content="blog, thebidouilleur, informatique, devops, the bidouilleur, kubernetes, docker, ansible, infra-as-code"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Loki - Monitor logs | TheBidouilleur"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="icon" href="/TheBidouilleur.xyz/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/docs/Adminsys/loki"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/en/docs/Adminsys/loki" hreflang="en"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/docs/Adminsys/loki" hreflang="fr"><link data-rh="true" rel="alternate" href="https://thebidouilleur.xyz/TheBidouilleur.xyz/docs/Adminsys/loki" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TheBidouilleur.xyz/en/blog/rss.xml" title="TheBidouilleur RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TheBidouilleur.xyz/en/blog/atom.xml" title="TheBidouilleur Atom Feed">




<script src="https://stats.192168128.xyz/js/script.js" defer="defer" data-domain="thebidouilleur.xyz"></script><link rel="stylesheet" href="/TheBidouilleur.xyz/en/assets/css/styles.a16b7bf2.css">
<link rel="preload" href="/TheBidouilleur.xyz/en/assets/js/runtime~main.3337d4b0.js" as="script">
<link rel="preload" href="/TheBidouilleur.xyz/en/assets/js/main.c6b24396.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TheBidouilleur.xyz/en/"><div class="navbar__logo"><img src="/TheBidouilleur.xyz/en/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--light_HNdA"><img src="/TheBidouilleur.xyz/en/img/BMO.svg" alt="TheBidouilleur" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TheBidouilleur</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/en/blog">Blog</a><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/TheBidouilleur.xyz/en/docs/Adminsys/loki" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/TheBidouilleur.xyz/docs/Adminsys/loki" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">Fran√ßais</a></li></ul></div><a class="navbar__item navbar__link" href="/TheBidouilleur.xyz/en/blog/archive">Archives</a><a href="https://twitter.com/thebidouilleur" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/TheBidouilleur.xyz/en/docs/Adminsys/dnsmasq">Adminsys</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/dnsmasq">DNS / DHCP avec DNSMASQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/rootless-libvirt">Using libvirt as non-root user</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/loki">Loki - Monitor logs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/MultiArch-Build">Build Docker multi-architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/packer-alpine">Introduction √† Packer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/Tinc">Tinc - VPN de Mesh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/creer-deb">Create your own Debian packages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/creer-repo-debian">Cr√©er son d√©pot Debian</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/netbootxyz">Boot PXE avec netboot</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/sops">Stocker des secrets dans un d√©p√¥t Git</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TheBidouilleur.xyz/en/docs/Adminsys/testinfra">V√©rification configuration syst√®me (testinfra)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/TheBidouilleur.xyz/en/docs/Home/cloudflared">Home</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/TheBidouilleur.xyz/en/docs/Kubernetes/kind">Kubernetes</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/TheBidouilleur.xyz/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Adminsys</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Loki - Monitor logs</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Loki - Monitor logs</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">‚Äã</a></h2><p>Ever since I started using computers (just under a decade), I have never bothered with how I visualize my logs. A little <em>view</em> here, a big <em>grep</em> there.. but no advanced management.</p><p>I have based my supervision on Zabbix and Grafana which show me the metrics of each virtual machine individually. And even if it&#x27;s very convenient, I have almost no visual on the state of my applications!
So I decided to find out about Graylog and Elastic Search offering a stack that is quite reliable and easy to set up. Then when I saw the resources requested, I postponed the need to &quot;later&quot;, and postponed it to next year. And so on!</p><blockquote><blockquote><p>2 years later...</p></blockquote></blockquote><p>Today <em>(December 2021)</em>, a big 0day fault is unveiled regarding Log4J, and we don&#x27;t talk about a &quot;small&quot; fault, it&#x27;s a good big RCE as we like them!</p><p>I am not concerned with Log4J, it is not used in Jenkins, and I have no other Java-based application open on the internet. But I would have liked to know if my server was scanned by the same IPs that are on the blacklists.
And it was with this event that I decided to inquire about <em>&quot;How to centralize and view its logs?&quot;</em>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="choosing-the-stack">Choosing the stack<a href="#choosing-the-stack" class="hash-link" aria-label="Direct link to Choosing the stack" title="Direct link to Choosing the stack">‚Äã</a></h2><p>A stack is a grouping of software used to respond to a function.
A classic example is the &quot;G.I.T.&quot; stack. <em>(not like the versioning tool!)</em>:</p><ul><li>Grafana</li><li>Influxdb</li><li>Telegraf</li></ul><p>It&#x27;s a stack that allows you to view the metrics of different machines, InfluxDB is the database that stores the information, Telegraf is the agent that allows the machines to send the metrics, and Grafana is the web service that allows you to view them.</p><p>As said in the introduction, I use Zabbix which allows me to monitor and collect metrics, and I&#x27;ve coupled Grafana to display them with a lot of settings.</p><p>In log centralization (and visualization), the following stack is often referred to:</p><p>*<strong>*ELK**</strong>:</p><ul><li>ElasticSearch</li><li>Logstash</li><li>Kibana</li></ul><p>But this stack is not to be deployed in any environment, it is efficient, but very heavy.</p><p>In my quest to find a stack that allows the centralization of logs, I will enjoy using services that I already have.
And here is the trendy miracle of 2021! Stack GLP: <strong>Grafana, Loki, Promtail</strong>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="stack-glp">Stack GLP<a href="#stack-glp" class="hash-link" aria-label="Direct link to Stack GLP" title="Direct link to Stack GLP">‚Äã</a></h3><p>What I really like about this stack is that it&#x27;s lightweight. Muchlighter than ELK which, although very effective, requires a lot.</p><p><img loading="lazy" src="https://i.imgur.com/oWOwWsJ.png" alt="Requirements of ELK" class="img_ev3q"></p><p>As well as Graylog2 + Elastic Search (a very good alternative) which almost requires a low-cost baremetal server alone.
<img loading="lazy" src="https://i.imgur.com/FkAq6sO.png" alt="Requirements of Graylog" class="img_ev3q"></p><p>While Grafana / Loki will require only 2GB to operate efficiently and without constraints. (maximum, at my scale: I will use much less than 2GB)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-our-stack">Install our stack<a href="#install-our-stack" class="hash-link" aria-label="Direct link to Install our stack" title="Direct link to Install our stack">‚Äã</a></h2><p>I assume that everyone knows how to install a Grafana, it is often towards this service that people start self-hosting <em>(at the same time, the grafana graphics are super sexy!)</em>.</p><p>But if you have not yet installed your Grafana <em>(in this case, leave the room and come back later)</em>, <a href="https://grafana.com/docs/grafana/latest/installation/" target="_blank" rel="noopener noreferrer">here is a link that will allow you to do it fairly quickly</a></p><p>For simplicity, I will not use Docker in this installation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="loki-part">Loki Part<a href="#loki-part" class="hash-link" aria-label="Direct link to Loki Part" title="Direct link to Loki Part">‚Äã</a></h3><p>I installed Loki on an LXC container following the guide on the official website <a href="https://grafana.com/docs/loki/latest/installation/local/" target="_blank" rel="noopener noreferrer">here</a>.
I go through systemd to run the executable, and I create a file in advance with the minimum requiered (available on the Grafana github)</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">auth_enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">http_listen_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">grpc_listen_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">common</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">path_prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /tmp/loki</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">filesystem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">chunks_directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /tmp/loki/chunks</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">rules_directory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /tmp/loki/rules</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">replication_factor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ring</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">instance_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kvstore</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">store</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inmemory</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">schema_config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">configs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">from</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token datetime number" style="color:rgb(247, 140, 108)">2020-10-24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">store</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> boltdb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">shipper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">object_store</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> filesystem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v11</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">prefix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> index_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 24h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I didn&#x27;t bother to enable authentication knowing that I&#x27;m on a LAN with only my virtual machines. I don&#x27;t consider my Loki as a sensitive point in my infra.</p><p>After only 2-3 minutes of configuration, our Loki is already available!</p><p>We can now add it as <em>datasource</em> on our Grafana:
<img loading="lazy" src="https://i.imgur.com/G3tWx1r.png" alt="Add loki as datasource" class="img_ev3q"></p><p><em>(I use localhost because the grafana machine also hosts the Loki</em>)</p><p><em>Grafana may have a bit of a problem because our Loki database is empty.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="promtail-section">Promtail Section<a href="#promtail-section" class="hash-link" aria-label="Direct link to Promtail Section" title="Direct link to Promtail Section">‚Äã</a></h3><p>Promtail is the agent that will allow us to send our logs to Loki, I wrote a rather simple Ansible role allowing me to install our agent on many machines by monitoring the logs from Docker, varlog and syslog.</p><p>Here is my Jinja2 template about my configuration:</p><div class="language-jinja2 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jinja2 codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  http_listen_port: 9080</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  grpc_listen_port: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">positions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  filename: /tmp/positions.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">clients:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if loki_url is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - url: {{ loki_url }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %} </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">scrape_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: authlog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %} </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: authlog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/log/auth.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: syslog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: syslog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/log/syslog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: Containers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: containerslogs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/lib/docker/containers/*/*-json.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- job_name: DaemonLog</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% if ansible_hostname is defined %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      host: {{ ansible_hostname }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      job: daemon</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      __path__: /var/log/daemon.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>If you are not comfortable with Jinja2 templates, you will find a &quot;pure&quot; version of the config <a href="https://git.thoughtless.eu/Cinabre/rolePromtailAgent/src/branch/master/README.md" target="_blank" rel="noopener noreferrer">here</a></em></p><p>You can of course adapt this template to your needs. My first idea is to have a &quot;base&quot; that I can put on each machine <em>(also knowing that if no log is available, as for Docker, Promtail will not cause an error by not finding the files)</em></p><p>Once Promtail is configured, it can be started via the executable directly:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/opt/promtail/promtail -config.file /opt/promtail/promtail-local-config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or via systemd <em>(automatic if you go through my playbook)</em>:
&#x27;systemctl start promtail&#x27;</p><p>Once this agent is everywhere, we&#x27;re going to have fun on Grafana!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="request-loki-from-grafana">Request Loki from Grafana<a href="#request-loki-from-grafana" class="hash-link" aria-label="Direct link to Request Loki from Grafana" title="Direct link to Request Loki from Grafana">‚Äã</a></h3><p>We&#x27;re going to do something rather counterintuitive. We&#x27;re not going to start with a Dashboard. we&#x27;ll test our requests first!
<em>Don&#x27;t swear, I swear it&#x27;s the most fun part!</em></p><p>On Grafana, we have an &quot;Explore&quot; tab. This will give us access to Loki by writing requests, these are quite simple, and especially by using the &quot;click-o-drome&quot; tool by unfolding the <em>Log Browser</em>
<img loading="lazy" src="https://i.imgur.com/UNL2s6m.png" alt="Grafana explore tab" class="img_ev3q"></p><p>With the template I gave you, you will have 4 jobs:</p><ul><li>daemon</li><li>authlog</li><li>syslog</li><li>containersjobs</li></ul><p>These jobs sort the logs, we&#x27;ll test that together. So we will select the machine <em>&quot;Ansible&quot;</em>, then ask for the job <em>&quot;authlog&quot;</em>.
I first click Ansible, then Authlog. Grafana will offer me exactly if I want to choose a specific file. If we don&#x27;t specify a file(<em>filename</em>) Grafana will take all <em>files (so it doesn&#x27;t matter if we only have one file)</em></p><p>(<em>you will notice later that as soon as we make our 1st selection, grafana will hide jobs/host/file that do not concern our start of request)</em></p><p><img loading="lazy" src="https://i.imgur.com/MWFQCyl.png" alt="Filter" class="img_ev3q"></p><p>By validating our request (*button <strong>show logs*</strong>)</p><p><img loading="lazy" src="https://i.imgur.com/RCpb5GI.png" alt="Show authlog of a machine" class="img_ev3q"></p><p>So we have the result of the query to Loki in the time lapse configured in Grafana (1h for me).
My authlog is not very interesting, and my syslog is polluted by many
not very relevant messages.</p><p>So we&#x27;ll start <strong>sorting</strong> our logs!</p><p>By clicking on the small &quot;<strong>*?</strong>&quot; above our request, we have a
&quot;cheatsheet&quot; summarizing the basic functions of Loki.
We discover how to do an exact search with<em>|=</em>, how to ignore
lines with<em>!=</em>and how to use a regular expression with<em>|~</em></p><p>I also share with you a slightly more complete cheatsheet that I found
on a blog: <a href="https://megamorf.gitlab.io/cheat-sheets/loki/" target="_blank" rel="noopener noreferrer">here</a></p><p>Thus, we can directly obtain slightly more colorful logs that will allow us to target the essential!</p><p><img loading="lazy" src="https://i.imgur.com/HzTwmwW.png" alt="Info,debug,error" class="img_ev3q"></p><p>(The idea is to target the nice logs with the colors that go with them)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2><p>If we often hear about the ELK suite, this is not a reason either
to use it at any cost! Loki is a good alternative offering
basic functionalities that will suffice for the most part.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TheBidouilleur.xyz/en/docs/tags/infra">infra</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/QJoly/TheBidouilleur.xyz/tree/main/docs/Adminsys/Loki.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-06-27T07:01:04.000Z">Jun 27, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/TheBidouilleur.xyz/en/docs/Adminsys/rootless-libvirt"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Using libvirt as non-root user</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/TheBidouilleur.xyz/en/docs/Adminsys/MultiArch-Build"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Build Docker multi-architecture</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#choosing-the-stack" class="table-of-contents__link toc-highlight">Choosing the stack</a><ul><li><a href="#stack-glp" class="table-of-contents__link toc-highlight">Stack GLP</a></li></ul></li><li><a href="#install-our-stack" class="table-of-contents__link toc-highlight">Install our stack</a><ul><li><a href="#loki-part" class="table-of-contents__link toc-highlight">Loki Part</a></li><li><a href="#promtail-section" class="table-of-contents__link toc-highlight">Promtail Section</a></li><li><a href="#request-loki-from-grafana" class="table-of-contents__link toc-highlight">Request Loki from Grafana</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/docs/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Me Suivre</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/TheBidouilleur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://thebidouilleur.xyz/blog/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Flux RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ko-fi.com/thebidouilleur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Me soutenir<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/TheBidouilleur.xyz/en/blog/archive">Historique</a></li><li class="footer__item"><a href="https://github.com/qjoly" target="_blank" rel="noopener noreferrer" class="footer__link-item">Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2023 TheBidouilleur.</div></div></div></footer></div>
<script src="/TheBidouilleur.xyz/en/assets/js/runtime~main.3337d4b0.js"></script>
<script src="/TheBidouilleur.xyz/en/assets/js/main.c6b24396.js"></script>
</body>
</html>